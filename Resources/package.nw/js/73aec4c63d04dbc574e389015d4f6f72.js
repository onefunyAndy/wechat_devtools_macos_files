'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('react'),d=require('classnames'),{connect:e}=require('react-redux'),f=require('image-size'),g=require('./a78e6d6a87de1708226375ca4c320d76.js'),h=require('./49d7d5660be793bc16a559def0301ebe.js'),j=require('./ad3b98d7cc192f62e059460218c54cea.js'),i=require('./a8c87029da0fa06e986298d447ab0fe2.js'),k=require('./e298e91f85bae5b5a2b792e6e73a55e3.js'),l=require('./9b479c57312553aee8af880b5c796a8f.js'),m=require('./673f3edf93bad4c2df981e52492e8a4d.js'),n=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),o=require('./874074ba4ecebc4e49310ccc42243ff5.js'),p=require('./cba9f1961ad06faf785db8d4f9fa3ed8.js'),q=require('./3c55dff3626a3ee184d599f076158345.js'),r=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),s=require('./db2217eb4cff896bdcbc50abe005058f.js'),t=require('./ff946754202ecf377034d29daac7c8d9.js'),u={".jpg":!0,".png":!0,".jpeg":!0,".icon":!0,".gif":!0,".svg":!0,".cer":!0};let v=!0;class w extends c.Component{constructor(a){super(a),this.state={evnListShow:!1,envListLeft:0,envListTop:0,leftTreeShow:!0,rightTreeShow:!0,switchEnvShow:!1,diffEnable:!1,uploadEnable:!1,uploadEnable:!1},this._onFileDiffMessage=this.onFileDiffMessage.bind(this),this._onFileChange=this.onFileChange.bind(this),this.mtimes=new Map,this.files=new Map}componentDidMount(){this.props.tcbActions.getEnvList(),this.setupWebview(),j.register(this._onFileDiffMessage)}componentWillReceiveProps(a){(a.scfMapInEnv!=this.props.scfMapInEnv||a.fileMapInEnv!=this.props.fileMapInEnv)&&process.nextTick(()=>{this.onRightFilesUpdate()}),a.currentEnv!=this.props.currentEnv&&process.nextTick(()=>{this.props.tcbActions.getTcbFuncList({writeFile:!1,showTips:!0}),this.updateProject()})}componentWillUnmount(){j.unRegister(this._onFileDiffMessage),this.fileUtils&&this.fileUtils.unWatch(this._onFileChange),v=!1}onRightFilesUpdate(){let a=this.props.currentEnv.namespace,b=this.props.scfMapInEnv[a],{files:c,info:d}=this.getCurrentEnvFiles();j.remoteEmit('REMOTE_UPDATE_FILE_LIST_BY_TYPE',{type:'right',files:c,info:d}),j.remoteEmit('UPDATE_TCB_FUNCTIONS',_extends({},b))}updateProject(){j.remoteEmit('UPDATE_PROJECT',_extends({},this.props.project,{leftName:'\u672C\u5730\u73AF\u5883',rightName:this.props.currentEnv.alias||'\u672A\u6307\u5B9A',name:this.props.project.projectname,path:this.props.project.projectpath,createTime:this.props.project.createTime}))}getCurrentEnvFiles(){let a=this.props.currentEnv.namespace,b=this.props.scfMapInEnv[a]||{},c=this.props.fileMapInEnv[a]||{},d=Object.keys(b).map((a)=>{return`/${a}`}),e={};for(const a of d)e[a]={isDir:!0,isFile:!1};let f=[];for(const a in c){let b=c[a],d=b.map((b)=>{return`/${a}/${b}`});f=f.concat(d)}for(const a of f)e[a]={isDir:!1,isFile:!0};return{files:f,info:e}}onFileDiffMessage(a){switch(a.type){case'INIT_PROJECT':{this.onReqInitProject(a);break}case'SYNC_FILES':{this.onReqSyncFiles(a);break}case'GET_FILE':{this.onReqGetFile(a);break}case'CURRENT_SELECT_PATH':{this.onCurrentSelectPath(a);break}case'FIND_IN_FILES':{this.onReqFindInFiles(a);break}}}getSerializableStat(a){return _extends({},a,{isDir:a.isDirectory(),isFile:!a.isDirectory()})}normalizePath(a){return a=b.posix.normalize(a),a.startsWith('/')?a.substr(1):a}getEditorPathFormat(a,c=!1){return a=b.posix.normalize(a),c&&!a.endsWith('/')&&(a+='/'),a.startsWith('/')?a:`/${a}`}async onFileChange(a,b,c){b=this.getEditorPathFormat(b);let d=c?+c.mtime:0,e=c?this.getSerializableStat(c):{},f={};if(('addDir'===a||'unlinkDir'===a)&&(b+='/'),'add'===a||'addDir'===a)this.files.set(b,!0),f={payload:{eventType:a,path:b,stat:e}};else if('unlink'===a||'unlinkDir'===a)this.files.delete(b),f={payload:{eventType:a,path:b,stat:e}};else if('change'===a){if(+this.files.get(b)==d)return;this.files.set(b,d),f={payload:{eventType:a,path:b,stat:e}}}else return void log.info(`edit.js watch ${a}`);f.eventType='REMOTE_EXTERNAL_FILE_CHANGE',f.type='EMIT',j.remoteEmit(f.eventType,f.payload)}async onCurrentSelectPath(a){j.callback(a.callback,{});let b={downloadEnable:!1,uploadEnable:!1};this.currentSelect=[],a.data.list.forEach((a)=>{let b=a.split('/').filter((a)=>{return!!a});1==b.length&&this.currentSelect.push(b[0])}),0<this.currentSelect.length&&('left'==a.data.type?b.uploadEnable=!0:'right'==a.data.type&&(b.downloadEnable=!0)),this.setState(b)}async onReqSyncFiles(a){const{files:b,info:c}=await this.getFiles();b.forEach((a)=>{this.files.set(a,!0)}),j.callback(a.callback,{files:b,info:c})}async getFileUtils(){return this.fileUtils||(this.fileUtils=await h(this.props.project),this.fileUtils.watch(this._onFileChange)),this.fileUtils}async getFiles(){function c(b){return new Promise((c,d)=>{a.lstat(b,(a,b)=>{a?d(a):c(b)})})}return new Promise(async(a)=>{const d=await this.getFileUtils(),e=d.getAllFileWithDir().map((a)=>'/'+a),f={},g=d.srcPath;for(const d of e)try{const a=await c(b.join(g,d));f[d]=_extends({},a,{isDir:a.isDirectory(),isFile:!a.isDirectory()})}catch(a){f[d]={}}a({files:e,info:f})})}async onReqInitProject(a){this.props.tcbActions.downloadAllTcbFunc({writeFile:!1,showTips:v,forceUpdate:!0});const b=this.getCurrentEnvFiles(),c={},d=this.props.settings;for(const b in d.appearance)c[b]=d.appearance[b];for(const b in d.edit)c[b]=d.edit[b];let e={errMsg:'',type:'CALLBACK',callback:a.callback,payload:{project:_extends({},this.props.project,{leftName:'\u672C\u5730\u73AF\u5883',rightName:this.props.currentEnv.alias||'\u672A\u6307\u5B9A',name:this.props.project.projectname,path:this.props.project.projectpath,createTime:this.props.project.createTime}),left:{files:[],info:{}},right:{files:b.files,info:b.info},tcbFnMap:this.props.scfMapInEnv[this.props.currentEnv.namespace],config:c}};[].forEach((a)=>{this.files.set(a,!0)}),j.callback(a.callback,e.payload)}async onReqFindInFiles(a){let{options:b,string:c}=a,{cwd:d,i:e,wholeword:f}=b,{error:g,res:h}=await o.grep({str:c,cwd:d,i:e,wholeword:f,namespace:this.props.currentEnv.namespace}),k={type:'CALLBACK',callback:a.callback};g?k.errMsg=JSON.stringify(g):(k.errMsg='',k.payload=h),j.callback(a.callback,k.payload,k.errMsg)}async onReqGetFile(c){await this.getFileUtils();let d=c.data.path,e=c.data.type,g=b.join(this.fileUtils.srcPath,d);if(u[b.extname(d).toLowerCase()]){let b=URL.resolve(`http://127.0.0.1:${global.proxyPort}/editor/files/`,this.normalizePath(d));try{b=decodeURI(b)}catch(a){}let e;try{e=f(g)}catch(a){e={width:-1,height:-1}}const h=a.statSync(g);j.callback(c.callback,{url:b,dimension:e,stat:this.getSerializableStat(h)})}else if('left'==e){if(d=this.normalizePath(d),this.fileUtils.exists(d)){const b=this.fileUtils.getFile(d),e=a.statSync(g);j.callback(c.callback,{data:b,stat:this.getSerializableStat(e)})}else j.callback(c.callback,{data:'',stat:{}});}else if('right'==e){let a=p.getFunctionInfo('/',d),b=await o.getFileContent({namespace:this.props.currentEnv.namespace,functionName:a.functionName,filePath:a.filePath});j.callback(c.callback,{data:b.toString(),stat:{size:(b||'').length,isDir:!1,isFile:!0}})}}toggleFileTree(a){let b='left'==a?'leftTreeShow':'rightTreeShow',c=!this.state[b];j.command('toggleFileTree',{show:c,type:a}),this.setState({[b]:c})}diffEnableClick(){let a=!this.state.diffEnable;j.command('diffEnable',{enable:a}),this.setState({diffEnable:!this.state.diffEnable})}onSettingClick(){this.props.setCloud({cloudfunctionRoot:{show:!0,in:'fnaction'}})}onUploadClick(){if(this.state.uploadEnable){if(!this.props.currentEnv||!this.props.currentEnv.namespace)return void this.props.setCloud({cloudfunctionRoot:{show:!0,in:'fnaction'}});const a=this.currentSelect.map((a)=>{return b.join(this.props.project.projectpath,this.props.project.cloudfunctionRoot,a)});this.props.tcbActions.uploadTcbFunctions({showTips:!0,dirPaths:a})}}onDownloadClick(){if(!this.state.downloadEnable)return;if(!this.props.currentEnv||!this.props.currentEnv.namespace)return void this.props.setCloud({cloudfunctionRoot:{show:!0,in:'fnaction'}});const a=s.get(r.WINDOW_REGISTRY.CLOUD_SCF_ACTION);if(!a)return;const b=document.createElement('input');b.style='display: none',b.setAttribute('type','file'),b.setAttribute('nwsaveas',`cloudfunctions`),a.window.document.body.appendChild(b),b.onchange=(c)=>{const d=c.target.value;d&&this.props.tcbActions.downloadTcbFunctions({showTips:!0,writeFile:!0,dirPath:d,functionNames:this.currentSelect}),a.window.document.body.removeChild(b)},b.click()}onEnvSelectClick(a){a.stopPropagation();const b=a.currentTarget.getBoundingClientRect();this.setState({evnListShow:!this.state.evnListShow,envListLeft:b.left,envListTop:b.top+22})}onSelectEnv(a){this.props.tcbActions.selectEnv(a),this.setState({evnListShow:!1})}setupWebview(){this.editorWebview&&this.container.removeChild(this.editorWebview);const a=g.get('editor');a.setAttribute('partition','persist:editor'),a.setAttribute('tabIndex','-1'),a.setAttribute('style','height: 100%; width: 100%;'),a.setUserAgentOverride(`${a.originUserAgent} devtoolsedit port/${global.messageCenterPort} proxy/${global.proxyPort}`),a.attach(this.container),a.on('newwindow',(a)=>{nw.Shell.openExternal(a.targetUrl)}),a.on('exit',(a)=>{('abnormal'===a.reason||'crashed'===a.reason||'killed'===a.reason)&&this.setupWebview()}),a.on('dialog',(a)=>{let b=a.messageType||'',c=a.messageText,d=a.dialog;'prompt'===b&&c===r.GET_MESSAGE_TOKEN&&d.ok(t.getToken())}),a.src='html/filediff.html',this.editorWebview=a}render(){const a=this.props,b=a.envList.map((a)=>{return a.alias});return c.createElement('div',{style:{height:'100%',width:'100%',display:'flex',flexDirection:'column'}},a.cloudfunctionRootShow?c.createElement(l,{isSetting:!0}):null,a.confirmShow?c.createElement(m,null):null,c.createElement(q,{id:'toolbar-cleancache-popup',show:this.state.evnListShow,left:this.state.envListLeft,top:this.state.envListTop,list:b,onSelectClick:this.onSelectEnv.bind(this)}),c.createElement('div',{className:'header'},c.createElement('div',{className:'toolbar'},c.createElement('div',{className:'toolbar-items'},c.createElement('div',{className:'toolbar-item-group'},c.createElement('div',{className:'toolbar-item'},c.createElement('div',{className:'toolbar-action',disabled:!this.state.downloadEnable,title:'\u8BF7\u9009\u62E9\u9700\u8981\u4E0B\u8F7D\u7684\u4E91\u51FD\u6570\uFF0C\u6309 ctrl \u53EF\u4EE5\u591A\u9009',onClick:this.onDownloadClick.bind(this)},c.createElement('div',{className:'toolbar-button'},c.createElement('i',{className:'ui-icon-download'})),c.createElement('p',{className:'toolbar-label'},'\u4E0B\u8F7D')))),c.createElement('div',{className:'toolbar-item-group'},c.createElement('div',{className:'toolbar-item'},c.createElement('div',{className:'toolbar-action-group'},c.createElement('div',{className:'toolbar-action',onClick:this.onEnvSelectClick.bind(this)},c.createElement('div',{className:'toolbar-action-selector'},c.createElement('p',{className:'toolbar-action-selector-holder'},a.currentEnv.alias),c.createElement('i',{className:d({"ui-icon-arrow-down":!this.state.evnListShow,"ui-icon-arrow-up":this.state.evnListShow})}))),c.createElement('div',{className:'toolbar-action',onClick:this.onSettingClick.bind(this)},c.createElement('div',{className:'toolbar-button'},c.createElement('i',{className:'ui-icon-cogs'})),c.createElement('p',{className:'toolbar-label'},'\u8BBE\u7F6E')))))))),c.createElement('div',{className:'main',ref:(a)=>this.container=a}))}}module.exports=e((a)=>{const b=a.project.current||{},c=b.tcb||{};return{confirmShow:a.window.tcbActionConfirmInfo&&a.window.tcbActionConfirmInfo.show,cloudfunctionRootShow:a.window.cloud&&a.window.cloud.cloudfunctionRoot&&a.window.cloud.cloudfunctionRoot.show&&'fnaction'==a.window.cloud.cloudfunctionRoot.in,project:b,settings:a.settings,envList:c.envList||[],currentEnv:c.currentEnv,scfMapInEnv:c.scfMapInEnv,fileMapInEnv:c.fileMapInEnv}},(a)=>{return{setCloud:(b)=>{a(i.setCloud(b))},showActionMsg:(b)=>{a(k.showActionMsg(b))},tcbActions:n.bindActionCreators(k,a)}})(w)}(require('lazyload'),require);