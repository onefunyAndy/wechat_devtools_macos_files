'use strict';!function(require,directRequire){function a(a,b){return{type:d.USER_UPDATE_ACCOUNT_STATUS,data:{openid:a,status:b}}}function b(a,b){return{type:d.USER_UPDATE_ACCOUNT,data:{openid:a,userInfo:b}}}const c=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),d=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),e=require('./89ba85d67a88f7636d657c22b5d3e038.js'),f=require('./84858de8a097c9cf84ff2c2e3d86e2a9.js'),g=require('./a8c87029da0fa06e986298d447ab0fe2.js'),h=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),i=require('./233d77ecf0781f44985f684f70e316d0.js'),j=require('./3bfffbe88b3d923921f851c0697974fe.js'),k=require('./f171257bbcaef547a3cf27266ccb0db2.js'),l=require('./df6d0ff021a69fb541c733de4dbba0fe.js'),{NOT_LOGIN:m,INVALID_TOKEN:n,INVALID_LOGIN:o,DEV_NEED_RELOGIN:p,DEV_INVALID_SIGNATURE:q,DEV_EXPIRED_SIGNATURE:r}=l;module.exports={login:function(a){return(b,c)=>new Promise(async(g,h)=>{const i=c(),j=i.window.mainWindow;b({type:d.USER_LOGIN_REQUEST});try{const c=await e.requestLogin(a);f.userInfo=c,g(c),b({type:d.USER_LOGIN_SUCCESS,userInfo:c})}catch(a){h(a),b({type:d.USER_LOGIN_FAIL,errMsg:a})}})},loginRequest:function(){return{type:d.USER_LOGIN_REQUEST}},loginPending:function(){return{type:d.USER_LOGIN_PENDING}},loginSuccess:function(a){return(b,e)=>{const h=e(),i=h.project.current;f.userInfo=a,i?g.setMainWindow(c.MAIN_WINDOW_TYPE.DEV)(b):f.lastSelect===c.MAIN_WINDOW_TYPE.WEB_DEBUGGER?g.setMainWindow(c.MAIN_WINDOW_TYPE.WEB_DEBUGGER)(b):g.setMainWindow(c.MAIN_WINDOW_TYPE.ENTRANCE)(b),b({type:d.USER_LOGIN_SUCCESS,userInfo:a})}},loginFail:function(a){return{type:d.USER_LOGIN_FAIL,err:a}},loginCancel:function(){return{type:d.USER_LOGIN_CANCAL}},loginExpired:function(a=null){return(b)=>{f.userInfo={},b({type:d.USER_LOGIN_EXPIRED,openid:a})}},removeUserInfo:function(a=null){return{type:d.USER_REMOVE_INFO,openid:a}},updateUserInfo:function(a){return{type:d.USER_UPDATE_INFO,userInfo:a}},syncUser:function(a,b){return a=a.user||{},f.refreshUserInfo(),{type:d.USER_SYNC_STORE,data:a,syncTime:b}},addAccount:function(a,b){return{type:d.USER_ADD_ACCOUNT,data:{openid:a,userInfo:b}}},removeAccount:function(a){return{type:d.USER_REMOVE_ACCOUNT,data:{openids:a}}},updateAccountStatus:a,checkAccountStatus:function(){return(d,f)=>{const g=function(f){const g=Date.now();if(!f.signature||!f.openid||!f.signatureExpiredTime||f.signatureExpiredTime<Date.now()||!f.newticket||!f.ticketExpiredTime)return void d(a(f.openid,c.LOGIN_STATUS.EXPIRED));if(f.ticketExpiredTime>g){const b=`${k.jsLoginURL}?${j.formatAppIDQuery()}&_r=${Math.random()}&newticket=${f.newticket}`;i({url:b,method:'post',body:JSON.stringify({scope:['snsapi_base']})},(b,e,g)=>{if(!b)try{const b=JSON.parse(g),e=b.baseresponse||{},h=e.errcode;h===m||h===n||h===p||h===r||h===q?d(a(f.openid,c.LOGIN_STATUS.EXPIRED)):void 0}catch(a){}})}else e.refreshTicketHelper(f,(e,g,h)=>{if(e)return void d(a(f.openid,c.LOGIN_STATUS.EXPIRED));let i;try{i=JSON.parse(h)}catch(b){return void d(a(f.openid,c.LOGIN_STATUS.EXPIRED))}const j=i.baseresponse,k=parseInt(j.errcode);if(0!=k)return void d(a(f.openid,c.LOGIN_STATUS.EXPIRED));const l=+new Date+1e3*i.ticket_expired_time,m=g.headers['debugger-newticket'];f.newticket=m,f.ticketExpiredTime=l,d(b(f.openid,f))})},h=f(),l=h.user.accountMap;for(const a in l){const b=l[a];g(b)}}}}}(require('lazyload'),require);