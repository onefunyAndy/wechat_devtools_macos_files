'use strict';!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('react'),d=require('./875171e7b864aa58d026d4fa0999fbd1.js'),e=require('./92320c1386e6db6a6f2556736a9bc280.js'),f=require('./c4b43629b4de3d73a79d27fb0314f46a.js'),g=require('./25d0beb4120ce2acafb4e03b95444fda.js'),h=require('./d247c706e8ed1b6ec9de35f99448d8e8.js'),i=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),j=require('./4152e7daed8b58a0b1bd0a083454e73f.js'),k=require('./6620a0cf7dad1b400d60f0fdae40f524.js'),l=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),m=require('./9e942ab5ae7ca9f57142dfe40a4b77e2.js'),n=require('./a3dbd8a227a46bf2bda5766bf515d780.js'),o=require('./e56b3f8f9a65ddb6e18ef417d763a1f6.js'),p=require('./common/locales/index.js'),{connect:q}=require('react-redux'),r=(a)=>({tree:a.cos.tree,currentPath:a.cos.currentPath,show:a.cos.show}),s=(a)=>({cosActions:i.bindActionCreators(f,a)});class t extends c.Component{constructor(a){super(a),this.state={ignoreList:[],progressInfo:'',uploadShow:!1,uploadEnd:!1,detail:{}}}componentWillReceiveProps(a){a.currentPath!=this.props.currentPath&&(clearTimeout(this.getDetailTimer),this.getDetailTimer=setTimeout(()=>{this.getResourceDetail()}))}componentDidMount(){this.props.cosActions.setDir('/',!0),this._cancalLocaleListener=p.onChangeLocale(()=>this.forceUpdate())}componentWillUnmount(){clearTimeout(this.getDetailTimer),clearTimeout(this.checkTaskResultTimer),this.props.cosActions.closeCosManager(),this._cancalLocaleListener()}getResourceDetail(){const a=this.props.tree[this.props.currentPath];if(a&&!a.isDir&&a.url){const c=j.whiteFileExtName,d=b.extname(a.url||'').toLowerCase(),e=c[d];e?this.setState({detail:{currentPath:this.props.currentPath,ext:d.replace(/^\./,'').toUpperCase(),type:e.type,name:e.name}}):j.getResourceDetail(this.props.currentPath,a.url).then((a)=>{a.currentPath==this.props.currentPath&&this.setState({detail:a})})}}async onUpload(a,b='/'){try{this.setState({ignoreList:[]});const a=await j.getTaskId();if(a&&0!=a.taskId&&'uploading'==a.status)return void this.props.cosActions.showError(p.config.RUNNING_TASK_TRY_AGAIN);const c=await j.getUploadFiles(this.progressHandler.bind(this));if(c){this.setState({uploadShow:!0,uploadEnd:!1}),this.progressHandler('progress',p.config.UPLOADING_LONG);const a=await j.upload(c,b);this.startTs=Date.now(),this.checkTaskResult(a.taskId,b)}}catch(a){this.setState({uploadShow:!1,uploadEnd:!0}),1003==a.code?this.props.cosActions.setConfirmInfo({show:!0,type:'error',title:p.config.TIP,content:p.config.QCLOUD_CDN_NOT_OPEN,showCancel:!0,showConfirm:!0,callback:(a)=>{a&&g.jumpQCloudPage('https://www.qcloud.com/login/laAccessCallback')},confirmText:p.config.OPEN_SERVICE}):this.props.cosActions.showError(a.toString())}}progressHandler(a,b){'ignore'==a?this.setState({ignoreList:this.state.ignoreList.concat([p.config.FILE_IGNORE_REASON.format([b.file,b.reason])])}):'zip'==a?this.setState({progressInfo:p.config.PACKAGING_SIZE.format([b.file,b.length])}):'progress'==a&&this.setState({progressInfo:b})}checkTaskResult(a,b){j.getTaskResult(a).then(({status:c})=>{'uploading'==c?(this.progressHandler('progress',p.config.PROCESSING_TIME_CONSUME.format(parseInt((Date.now()-this.startTs)/1e3))),this.checkTaskResultTimer=setTimeout(()=>{this.checkTaskResult(a,b)},1e3)):'failed'==c?(this.setState({uploadEnd:!0}),this.props.cosActions.showError(p.config.UPLOAD_FAIL_TRY_AGAIN)):'complete'==c?(this.setState({uploadEnd:!0}),this.progressHandler('progress',p.config.UPLOAD_SUCCESSFULLY),this.props.cosActions.setDir(b,!0)):'timeout'==c&&(this.setState({uploadEnd:!0}),this.props.cosActions.showError(p.config.TASK_TIMEOUT_TRY_AGAIN),this.props.cosActions.setDir(b,!0))}).catch((a)=>{this.props.cosActions.showError(a.toString())})}renderInfo(){return c.createElement('div',{className:'intro'},c.createElement('div',{className:'intro-text-area'},c.createElement('h4',{className:'intro-title'},p.config.NO_MATERIAL_UPLOADED)),c.createElement('div',{className:'intro-desc-area'},c.createElement('p',{className:'intro-desc'},'1. ',p.config.SUPPORTED_FILE_FORMATS,' png\u3001jpg\u3001jpeg\u3001bmp\u3001gif\u3001mp3\u3001mp4\u3001m4a\u3001ogg\u3001svg'),c.createElement('p',{className:'intro-desc'},'2. ',p.config.UPLOAD_SIZE_LIMIT)),c.createElement('div',{className:'intro-button-area'},c.createElement('button',{className:'ui-button ui-button-primary',onClick:this.onUpload.bind(this)},p.config.UPLOAD_MATERIAL)))}onContainerClick(){this.props.cosActions.setContextMenu({show:!1})}onUploadClose(){this.setState({uploadShow:!1})}onCopyUrlClick(){const a=this.props.tree[this.props.currentPath]||{},b=nw.Clipboard.get();b.set(a.url,'text')}renderMgr(){const a=this.props.tree[this.props.currentPath]||{};let b={},d=null;return this.state.detail&&this.state.detail.currentPath==this.props.currentPath&&(b=this.state.detail,'img'==b.type?d=c.createElement('div',{className:'file-mgr-detail-thumbnail',style:{backgroundImage:`url('${a.url}')`,backgroundPosition:'center center',backgroundRepeat:'no-repeat',backgroundSize:'contain'}}):'audio'==b.type?d=c.createElement('audio',{src:a.url,controls:!0}):'video'==b.type&&(d=c.createElement('video',{src:a.url,controls:!0}))),c.createElement('div',{className:'file-mgr',style:{height:'100%'}},c.createElement('div',{className:'file-mgr-explore',style:{width:250}},c.createElement('div',{className:'file-mgr-toolbar',onClick:this.onUpload.bind(this)},c.createElement('div',{className:'file-mgr-toolbar-bd'},c.createElement('a',{className:'file-mgr-toolbar-item'},c.createElement('i',{className:'ui-icon-plus'}),c.createElement('span',{className:'file-mgr-toolbar-name'},p.config.UPLOAD_FILES)))),c.createElement('div',{className:'file-mgr-bd'},c.createElement(h,null))),c.createElement('div',{className:'file-mgr-preview',style:{userSelect:'auto'}},c.createElement('div',{className:'file-mgr-detail',style:{display:a.url&&!a.isDir?'':'none'}},d,c.createElement('p',{className:'file-mgr-detail-name'},a.name),c.createElement('div',{className:'file-mgr-detail-metas'},c.createElement('div',{className:'file-mgr-detail-meta'},c.createElement('p',{className:'file-mgr-detail-label'}),c.createElement('p',{className:'file-mgr-detail-value file-mgr-detail-desc'},b.ext,' ',b.name,' \u2014 ',1024>a.size?a.size:parseInt(a.size/1024)+'K','B')),c.createElement('div',{className:'file-mgr-detail-meta'},c.createElement('p',{className:'file-mgr-detail-label'},p.config.CREATION_TIME),c.createElement('p',{className:'file-mgr-detail-value'},a.lastModified)),c.createElement('div',{className:'file-mgr-detail-meta'},c.createElement('p',{className:'file-mgr-detail-label'},'URL'),c.createElement('p',{className:'file-mgr-detail-value'},c.createElement('span',null,a.url),c.createElement('a',{onClick:this.onCopyUrlClick.bind(this)},p.config.COPY)))))))}render(){const a=this.props,b=this.state.ignoreList.map((a)=>{c.createElement('div',{key:a},a)}),d=a.tree&&1<Object.keys(a.tree).length;return c.createElement('div',{style:{height:'100%'},onClick:this.onContainerClick.bind(this)},c.createElement(m,null),c.createElement(n,{progress:this.state.progressInfo,tips:this.state.ignoreList,show:this.state.uploadShow,end:this.state.uploadEnd,onClose:this.onUploadClose.bind(this)}),c.createElement(o,null),d?this.renderMgr():this.renderInfo())}}const u=q(r,s)(t);class v extends c.Component{constructor(a){super(a)}onClose(){this.props.cosActions.closeCosManager()}componentWillUnmount(){this.props.cosActions.closeCosManager()}render(){return c.createElement(k,{title:p.config.MENU_COS,registryId:l.WINDOW_REGISTRY.MATERIAL,width:l.SIZE.MATERIAL.WIDTH,height:l.SIZE.MATERIAL.HEIGHT,resizable:!1,onWindowClose:this.onClose.bind(this),templateHTML:'html/material.html',always_on_top:!0},c.createElement(u,null))}}module.exports=q(r,s)(v)}(require('lazyload'),require);