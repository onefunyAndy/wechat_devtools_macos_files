'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){async function a(a,b){const c=[];for(const d of a){let a=!1;for(const c of b)if('file'===c.type&&c.value===d){a=!0,delete A[d];break}else if('folder'==c.type&&0===d.indexOf(c.value)){a=!0,delete A[d];break}a||A[d]||c.push(d)}try{if(0<c.length){let{body:a}=await p({url:q.translateFilename,method:'post',body:JSON.stringify({path:c}),needToken:1,needAppID:1});a.pairs.forEach((a)=>{A[a.origin]=a.translated+'.js'})}}catch(a){i.error(`uglifyFileNames catch error ${a}`);const b={};for(const a of c)b[a]=n.generateMD5(a)+'.js';return _extends({},A,b)}return A}async function b(a){return new Promise(async(b,c)=>{try{const c=await l({taskName:'processJS',config:{projectPath:a.projectPath,file:a.file,es6:a.es6?'yes':'no',minified:a.minified?'yes':'no',sourceMaps:'map',uglifyFileName:a.uglifyFileName?'yes':'no',sourceFileName:a.file,nameMapping:JSON.stringify(a.nameMapping)},dataStr:a.code,maxTimeout:180000,useBackup:!0,downgrade:!1,onAfterRun:a.onAfterRun,forceBackup:s,showInStatus:{text:`compiling ${a.file}`}});b(c)}catch(a){a instanceof Error?c(a):c(new Error(a))}})}async function c(a,c={}){return new Promise(async(g,i)=>{z[a.hash||'']||(z[a.hash||'']={});const j=z[a.hash||''],{es6:k,minified:l}=a.setting,o=!1,{srcFilePath:p,fileBuffer:q,destFilePath:r,destPath:s,fileName:w,onAfterRun:x,projectPath:y,filesIgnored:A,nameMapping:B}=c;let C=u(q),D='';if(void 0===C){const a=new Error(h.config.FILE_NOT_UTF8.format(p));return a.code=v,i(a)}const E=Date.now(),F=n.generateMD5(C),G=`${p}_${k}_${l}_${o}`;if(j[G]&&j[G].md5===F)(k||l)&&C.length>=t&&(A||[]).push(w),C=j[G].jsCode,D=j[G].map,console.log('compile js',w,'in cache, skip.');else{if((k||l)&&C.length<t){const a=await b({projectPath:y,file:w,es6:k,minified:l,sourceFileName:w,code:C,onAfterRun:x,uglifyFileName:o,nameMapping:B});if(console.log(`process ${w} cost time: ${Date.now()-E}`),a.error){const b=a.error,c=new Error(b.message||b);return c.code=b.code,i(c)}C=a.code,D=a.map}else(k||l)&&512000<=C.length&&(A||[]).push(w),D=await m(e.join(y,w),C);try{'string'==typeof D&&(D=JSON.parse(D)),D=await m.insertSourcesContent(D,e.join(y,w)),D=JSON.stringify(D)}catch(a){D=null}j[G]={md5:F,jsCode:C,map:D}}const H=w,I=e.join(s,H),J=e.dirname(I);f.sync(J),D&&d.writeFileSync(e.join(s,`${H}.map`),D),d.writeFileSync(I,C),g()})}const d=require('fs'),e=require('path'),f=require('mkdir-p'),g=require('./162bf2ee28b76d3b3d95b685cede4146.js'),h=require('./common/locales/index.js'),i=require('./72653d4b93cdd7443296229431a7aa9a.js'),j=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),k=require('./a63026ab5a5a3c59a61a9749a18aa2ca.js'),l=require('./41168dca39589e852da6631126d0f94d.js'),m=require('./cdbf7243dc99f8461acbb1d57af1d8ae.js'),n=require('./84b183688a46c9e2626d3e6f83365e13.js'),o=require('./1dea83a77e99a7c94f6b6f01f5c175b0.js'),p=require('./15ba1827c7f6564a45df6bd44da3a977.js'),q=require('./f171257bbcaef547a3cf27266ccb0db2.js'),r=require('./1c8a8c710417d102ab574145dc51b4b0.js'),s=!1,t=512000,{bufToUTF8:u}=require('./efc820e1b92d6e4063535296d4a24213.js'),{FILE_NOT_UTF8:v,BABEL_TRANS_JS_ERR:w,UGLIFY_JS_ERR:x,BABILI_JS_ERR:y}=require('./949d8235c744ced2a80121e4dba34c28.js'),z={},A={};module.exports=async function(b,d={}){const f=b.compileType,{distPath:l,onProgressUpdate:i,onFilesIgnored:m}=d;let n=await g(b);const p=(b.packOptions||{}).ignore||[];let q=n.getAllJSFiles().filter((a)=>!r.isFileIgnored(a,p)),s={};if(b.setting.uglifyFileName){let c=[{type:'file',value:'app.js'}];const d=n.getAllWXMLFiles();for(const a of d)c.push({type:'file',value:`${a.replace(/\.wxml$/,'.js')}`});const e=await o(b);e.widgets&&0<e.widgets.length&&e.widgets.forEach((a)=>{c.push({type:'folder',value:/\/$/.test(a.path)?a.path:`${a.path}/`})}),console.log(c),s=await a(q,c)}console.log(s);let t=f==j.plugin?b.miniprogramRoot:'';const u=[],v=[];let w=[...q],x=(a)=>{const b=w.findIndex((b)=>b===a);0<=b&&w.splice(b,1),w[0]&&i('compilejs',h.config.PROCESSING.format(w[0]))};for(let a=0,f=q.length;a<f;a++){const d=q[a],f=n.getFile(d,null);v.push(c(b,{projectPath:n.srcPath,srcFilePath:e.join(t,d),destFilePath:e.join(l,t,d),destPath:e.join(l,t),fileBuffer:f,fileName:d,onAfterRun:x.bind(null,d),filesIgnored:u,nameMapping:s}))}const y=Date.now();if(await Promise.all(v),f==j.plugin){n=await k(b),q=n.getAllJSFiles(),t=b.pluginRoot;const a=[];w=[...q],x=(a)=>{const b=w.findIndex((b)=>b===a);0<=b&&w.splice(b,1),w[0]&&i('compilejs',h.config.PROCESSING.format(w[0]))};for(let d=0,f=q.length;d<f;d++){const f=q[d],g=n.getFile(f,null);a.push(c(b,{projectPath:n.srcPath,srcFilePath:e.join(t,f),destFilePath:e.join(l,t,f),destPath:e.join(l,t),fileBuffer:g,fileName:f,onAfterRun:x.bind(null,f),filesIgnored:u}))}await Promise.all(a)}console.log('compile all js cost time',Date.now()-y),m(u)}}(require('lazyload'),require);