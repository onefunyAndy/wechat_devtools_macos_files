'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('path'),b=require('react'),{connect:c}=require('react-redux'),d=require('prop-types'),e=require('redux'),f=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),g=require('./a8c87029da0fa06e986298d447ab0fe2.js'),h=require('./ba23d8b47b1f4ea08b9fd49939b9443f.js'),i=require('./e98c60a262d8d98e69e574a9d12a21df.js'),j=require('./5451dfc4d939398d913dc724d952b02b.js'),k=require('./6620a0cf7dad1b400d60f0fdae40f524.js'),l=require('./efaddce19b790978e16990920754b000.js'),m=require('./584aae91d7c83393222029103ba1ac29.js'),n=require('./925e13dda17a5a2e1cbaf0212c56c31c.js'),o=require('./0df497a6fb76113a0a8e66dad897263e.js'),p=require('./aee2b6963336bb84d2ce0e0ed38dae60.js'),q=require('./cf7022509ac3e29b8293eb12f244de20.js'),r=require('./0ac4da1c7ab84710f2c94e3bf0cf4861.js'),s=require('./3274726e14e61776145df49bcfdcf89c.js'),t=require('./fe312864f5142b11bfe28ad1bc5ad2f8.js'),u=require('./a1fed34995a9fdae4b41f1acb9c2e5a9.js'),v=require('./d3ca3f15cb99fc14bb8fbfeeb32ad0f5.js'),w=require('./444cd5bc8c3d312afefcdada704d0f95.js'),x=require('./b1ba6dfcea5ed09bd8f7edf39a8149d6.js'),y=require('./7d9f39319673925120c4a1020d58dbd7.js'),z=require('./a3b5b3f603a2b65817dc1171b7ec7a8d.js'),A=require('./a254abb81b6346b59aa82a08652fe610.js'),B=require('./d51f6457067a06cf51fac263b2c25b60.js'),C=require('./8e764a20d4ff4876a256ceb36e40c37e.js'),D=require('./da7c31daaf542cf1796023d8e344b98a.js'),E=require('./d326caa17e34aabeda5187fbed6e1e47.js'),F=require('./af9e5b2040c286e3da6d2e3b30eae482.js'),G=require('./00bb746364abbf48ca081de687ce505a.js'),H=require('./59aba0523016c691a75262d7f9a6b793.js'),I=require('./bf5bd8b977a68a4f788a29b92aa86a0e.js'),J=require('./76c2144bb016d8e91614bb612002ad72.js'),K=require('./d24cc22e4b11eda71b5615ee005c61df.js'),L=require('./c465c4038a3000251743734c502c80ed.js'),M=require('./5fce949eb42d709c19a90da9440a955b.js'),N=require('./3abac29230bbc52f03349d2cd4796dd0.js'),O=require('./0ba8bbb520f446ec68be8010f175693d.js'),P=require('./dc59f57d54946e61d27c95ab24d8cb4f.js'),Q=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),R=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),S=require('./3b66d845db4d098b7a16cb0357f5c072.js'),T=require('./eadce02c750c875a10680bcfedadec88.js'),U=require('./3b4ae76898f5e38e0fa745be867d8de3.js'),V=require('./37d8b9297fb1bd87f9a3ac407b8006a0.js'),W=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),X=require('./f4b122ca93225892eb1487c959c929f6.js'),Y=require('./d62fc37d7aa6416d5dcc240ba94175cd.js'),Z=require('./106eac0139723db6a35b934f19cb4aa5.js'),$=require('./03b7faa8f76486fc3878b17c9a674a7e.js'),_=require('./5dc59f418d85e854c1a12d402d29e2d7.js'),aa=require('./bc0aa9e11159f5769f00d6e8f5ac5aae.js'),ba=require('./1fb8a98e60701d8613c61212cbdcec59.js'),ca=require('./7c591e7ca2a6d4233e0576df641c0d52.js'),da=require('./24e8c82117f6ac2c1c7ca8e4c8d6068d.js'),ea=require('./7e488c799c93aca16e477543d07891ec.js'),fa=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),ga=require('./42191d95974f14b18961c9f2c730464e.js'),ha=require('./9b479c57312553aee8af880b5c796a8f.js'),ia=require('./f5a748840b272d2bf0223c95f6c8dbe3.js'),ja=require('./e323ab13407f3249b9fcba4b18f4ba89.js'),ka=require('./ffc9a3cdcc5036d1fb62a2324c72a2b0.js'),la=require('./common/locales/index.js'),ma=require('./806427363b293db20edb3e7c3f8d8b72.js'),na='darwin'===process.platform;class oa extends b.Component{constructor(a){super(a),this.state={},this.lastWorkbenchShowWindowWidth=0,this._onConfigUpdate=this.onConfigUpdate.bind(this),this.reportMemoryTimer=null,this.lastReportMemory=0,this.lastReportMemoryTime=0,this._onResize=this.onResize.bind(this),this._onMove=this.onMove.bind(this)}componentDidMount(){if(this.props.win||global.isDevWindow){const a=this.props.win||global.Win;global.windowMap.set('MAIN',a),!1,a.on('resize',this._onResize),j.init(a),j.update()}const a=P.get();a&&a.scene&&this.props.updateSceneConfig(a),U.startSync(),P.on('CONFIG_UPDATE',this._onConfigUpdate),this.reportMemoryTimer=setInterval(this.reportMemory.bind(this),300000),this.props.requestProjectAttr(),this.watchProjectConfig();try{let a=ia.getInstalledPluginManifest();this.props.setPluginManifests(a)}catch(a){}ka.addListener(),this._cancalLocaleListener=la.onChangeLocale(this.props.updateLocaleSceneConfig)}componentWillUnmount(){P.off('CONFIG_UPDATE',this._onConfigUpdate),U.stopSync(),clearInterval(this.reportMemoryTimer),ka.removeListener(),this._cancalLocaleListener()}componentWillReceiveProps(a){a.workbenchShow!=this.props.workbenchShow&&(a.workbenchShow?global.Win.width=Math.max(this.lastWorkbenchShowWindowWidth,global.Win.width,a.simulatorWindowWidth+100):(this.lastWorkbenchShowWindowWidth=global.Win.width,global.Win.width=a.simulatorWindowWidth))}getChildContext(){return{currentNWWindow:this.props.win?this.props.win:global.Win}}async watchProjectConfig(){const b=this.props.project;this.projectFiles=await Y(b.projectpath),this.projectFiles.on('all',(c,d)=>{d=a.relative(b.projectpath,d),'project.config.json'==d&&this.projectConfigFileChanged()}),this.projectConfigFileChanged()}async projectConfigFileChanged(){const a=this.props.project,b=ga.getConfigFileInfo(a);if(!b.error)this.props.setProjectConfig(b.config);else{let a=null;'readerror'===b.error.type?a={title:'',content:la.config.PROJECT_CONFIG_READ_ERROR,showCancel:!1}:'parseerror'===b.error.type?a={title:'',content:la.config.PROJECT_CONFIG_PARSE_ERROR,showCancel:!1}:'contenterror'===b.error.type&&(a={title:'',content:la.config.PROJECT_CONFIG_CONTENT_ERROR.format(b.error.message),showCancel:!1}),a&&this.props.confirm(a)}}onResize(a,b){this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(()=>{this.props.windowActions.appResize({width:a,height:b}),this.resizeTimer=null},20)}onMove(a,b){this.moveTimer&&clearTimeout(this.moveTimer),this.moveTimer=setTimeout(()=>{this.props.windowActions.appResize({x:a,y:b}),this.moveTimer=null},20)}checkWindowStatus(){const a=this.props.windowStatus.mode;if(a==f.WINDOW_MODE.FULLSCREEN)this.props.win.enterFullscreen();else if(a==f.WINDOW_MODE.WINDOW_MAXIMIZE)this.props.win.maximize();else if(a==f.WINDOW_MODE.FREE){const a=this.props.windowStatus.position;this.props.win.moveTo(a.x,a.y),this.props.win.resizeTo(a.width,a.height)}}onBodyClick(a){this.props.clickkey!=T.NONE&&this.props.bodyClick(a),a.target.partition?'persist:editor'===a.target.partition?this.props.recordFocus(f.WINDOW_FOCUS.EDITOR):'persist:devtools'===a.target.partition?this.props.recordFocus(f.WINDOW_FOCUS.DEVTOOLS):'persist:remotedebugdevtools'===a.target.partition&&this.props.recordFocus(f.WINDOW_FOCUS.REMOTE_DEBUG_DEVTOOLS):this.props.recordFocus(f.WINDOW_FOCUS.BODY)}reportMemory(){chrome.processes.getProcessInfo([],!0,(a)=>{let b=0;for(const c in a){const d=a[c];d.privateMemory&&(b+=d.privateMemory)}b=parseInt(b/1024/1024);isNaN(b)||(Date.now()-this.lastReportMemoryTime>7200000||100<Math.abs(b-this.lastReportMemory))&&(console.log('memory_monitor',this.props.project.appid,`${b},${this.props.restartTimes}`),D('memory_monitor',this.props.project.appid,`${b},${this.props.restartTimes}`),this.lastReportMemoryTime=Date.now(),this.lastReportMemory=b)})}onConfigUpdate(a){this.props.updateSceneConfig(a)}onAboutClick(){this.props.windowActions.setAboutWindow({show:!0})}onSimulatorWindowReady(){'popup'===this.props.simulatorPosition&&this.props.simulatorActions.compile()}onDevtoolsWindowReady(){}onSimulatorWindowClose(){this.props.windowActions.setSimulatorPosition('left')}onDevtoolsWindowClose(){this.props.windowActions.setDebuggerWindow({popup:!1})}getSimulator(a){const c=this.props;let d=c.simulatorWindowWidth;if(c.simulatorShow?!c.workbenchShow&&(d='100%'):d=0,'popup'===c.simulatorPosition){let d;if(c.project.attr&&c.project.attr.gameApp)d=a==R.conversation||a==R.search?z:A;else switch(a){case R.weapp:case R.plugin:{d=m;break}case R.search:case R.conversation:{d=z;break}default:return null;}const e={className:'standalone',onClick:this.onBodyClick.bind(this)};return b.createElement(k,{templateHTML:'html/standalone.html',wrapperProps:e,title:la.config.SIMULATOR_WINDOW_TITLE.format(decodeURIComponent(c.project.projectname)),frame:!0,show:!1,width:c.deviceWidth,height:c.deviceHeight+27,resizable:!1,fullscreen:!1,always_on_top:!1,onWindowClose:this.onSimulatorWindowClose.bind(this),onReady:this.onSimulatorWindowReady.bind(this),renderClass:d})}return c.project.attr&&c.project.attr.gameApp?a==R.conversation||a==R.search?b.createElement(z,{width:d}):b.createElement(A,{width:d}):a===R.weapp||a===R.plugin?b.createElement(m,{width:d}):a===R.search||a===R.conversation?b.createElement(z,{width:d}):null}getService(a){const c=this.props,d=c.debuggerHeight;if(c.debuggerPopup){let e;if(c.project.attr&&c.project.attr.gameApp&&(a==R.conversation||a==R.search?e=y:e=B),!e)switch(a){case R.weapp:case R.plugin:{e=x;break}case R.search:case R.conversation:{e=y;break}default:return null;}return b.createElement(k,{title:la.config.DEBUGGER_WINDOW_TITLE.format(decodeURIComponent(c.project.projectname)),frame:!0,show:!1,height:d,resizable:!0,fullscreen:!1,always_on_top:!1,onWindowClose:this.onDevtoolsWindowClose.bind(this),onReady:this.onDevtoolsWindowReady.bind(this),renderClass:e,renderProps:{height:d}})}return c.project.attr&&c.project.attr.gameApp?a==R.conversation||a==R.search?b.createElement(y,{height:d}):b.createElement(B,{height:d}):a===R.weapp||a===R.plugin?b.createElement(x,{height:d}):a===R.search||a===R.conversation?b.createElement(y,{height:d}):null}getOptionsWindows(){const a=this.props;let c=[];for(const d in a.showQCloudUploading&&c.push(b.createElement(v,{key:'qclouduploading'})),a.showCustomAnalysis&&c.push(b.createElement(o,{key:'customanalysis'})),a.showMobileTest&&c.push(b.createElement(p,{key:'mobiletest'})),a.showCloudConsole&&a.pluginManifests.cloudconsole&&c.push(b.createElement(q,{key:'cloudconsole',manifest:a.pluginManifests.cloudconsole})),a.showSelectProject&&c.push(b.createElement(K,{detach:!0,key:'selectproject'})),a.showCreateProject&&c.push(b.createElement(L,{detach:!0,key:'createproject'})),a.showRemoteDebugWindow&&c.push(b.createElement(M,{key:'remotedebug'})),a.showQCloudDebugWindow&&c.push(b.createElement(N,{key:'qclouddebug'})),a.showTcbFnActionWindow&&c.push(b.createElement(ba,{key:'tcbfnaction'})),a.showTcbLoadingWindow&&c.push(b.createElement(ca,{key:'tcbloading'})),a.pluginPopup)if(a.pluginPopup[d]&&a.pluginManifests[d]){let e=a.pluginManifests[d];c.push(b.createElement(ja,{key:`pluginpopup_${d}`,pluginId:d,manifest:e}))}return c}getOptionsComponents(){const a=this.props,c=[];return a.shareInfoShow&&c.push(b.createElement(F,{key:'share'})),a.uploadinfoShow&&c.push(b.createElement(G,{key:'upload'})),a.uploadPluginDocInfoShow&&c.push(b.createElement(H,{key:'uploadplugindoc'})),a.changeAppIdInfoShow&&c.push(b.createElement(J,{key:'changeAppId'})),a.noticecenterShow&&c.push(b.createElement(C,{key:'noticecenter'})),a.addDeviceShow&&c.push(b.createElement(Z,{key:'adddevice'})),a.qcloudUploadDialogShow&&c.push(b.createElement(t,{key:'qclouduploaddialog'})),a.qcloudDeployDialogShow&&c.push(b.createElement(w,{key:'qclouddeploydialog'})),a.qcloudUploadIDCShow&&c.push(b.createElement(u,{key:'qclouduploadidc'})),a.musicShow&&c.push(b.createElement($,{key:'music'})),a.iconManagerShow&&c.push(b.createElement(s,{key:'iconmanager'})),a.showCosManager&&c.push(b.createElement(aa,{key:'cos'})),a.showTcbFnRoot&&c.push(b.createElement(ha,{key:'tcbfnroot'})),a.showAccountBox&&c.push(b.createElement(da,{key:'accountbox'})),a.additionLoginShow&&c.push(b.createElement(ea,{key:'additionlogin'})),a.confirmShow&&c.push(b.createElement(I,{key:'confirm'})),c}render(){const a=this.props,c=a.project.compileType;let d='workbench';a.workbenchShow||(d+=' ui-invisible');let e=null;return this.props.maskType&&this.props.maskType===f.MASK_TYPE.GLOBAL_BLOCKING&&(e=b.createElement('div',{className:'ui-mask ui-mask-transparent'})),b.createElement('div',{style:{height:'inherit'},onClick:this.onBodyClick.bind(this)},b.createElement(n,null),b.createElement('div',{className:'left'===a.simulatorPosition?'main':'main main-reverse'},a.showGitPanel?b.createElement(O,{key:'gitpanel'}):null,b.createElement(r,{compileType:c,project:this.props.project}),this.getOptionsComponents(),b.createElement('div',{onMouseDown:this.onBodyClick.bind(this),style:{width:a.workbenchShow?'inherit':'100%'}},this.getSimulator(c)),b.createElement('div',{className:d,style:{overflow:'hidden'},onMouseDown:this.onBodyClick.bind(this)},global.onlySimulator?null:b.createElement(l,null),this.getService(c),b.createElement(ma,null)),b.createElement(E,null),this.getOptionsWindows()),b.createElement(X,null),e)}}oa.childContextTypes={currentNWWindow:d.object},module.exports=c((a)=>{const b=a.window.debug||{},c=a.window.editor||{},d=a.window.simulator||{},e=a.info.shareInfo||{},f=a.info.uploadInfo||{},g=a.info.uploadPluginDocInfo||{},h=a.info.confirmInfo||{},i=a.toolbar.deviceInfo||{},j=a.toolbar.clickKey,k=a.simulator.music&&a.simulator.music.status,l=a.info.changeAppIdInfo||{};return{appLaunched:a.simulator.appLaunched,debuggerHeight:b.height||100,debuggerPopup:b.popup,simulatorWindowWidth:d.width||500,workbenchShow:b.show&&!b.popup||c.show&&!c.popup,simulatorShow:d.show,simulatorPosition:d.position,shareInfoShow:e.show,uploadinfoShow:f.show,uploadPluginDocInfoShow:g.show,changeAppIdInfoShow:l.show,deviceWidth:i.screenWidth,deviceHeight:i.screenHeight,addDeviceShow:a.info.addDeviceInfo&&a.info.addDeviceInfo.show,noticecenterShow:T.NOTICECENTER==j||T.LOGINQRCODE==j,clickkey:j,confirmShow:h.show,maskType:a.window.mask.show?a.window.mask.type:'',showAccountBox:a.window.multiAccountBox&&a.window.multiAccountBox.show,showCustomAnalysis:a.debug.customAnalysis.isOpen,showMobileTest:a.debug.mobileTest.isOpen,showCloudConsole:a.window.cloud&&a.window.cloud.console&&a.window.cloud.console.show,showTcbFnActionWindow:a.window.cloud&&a.window.cloud.fnaction&&a.window.cloud.fnaction.show,showTcbFnRoot:a.window.cloud&&a.window.cloud.cloudfunctionRoot&&a.window.cloud.cloudfunctionRoot.show&&'main'==a.window.cloud.cloudfunctionRoot.in,showCosManager:a.cos.show,showSelectProject:!!a.window.popup.selectProject&&a.window.popup.selectProject.show,showCreateProject:!!a.window.popup.createProject&&a.window.popup.createProject.show,showRemoteDebugWindow:!!a.window.remoteDebugWindow.show,showQCloudDebugWindow:!!a.window.qcloudDebugWindow.show,showGitPanel:!!a.git.panelShow,showQCloudUploading:a.window.qcloud.uploading&&a.window.qcloud.uploading.show,showTcbLoadingWindow:a.window.tcbLoading&&a.window.tcbLoading.show,project:a.project.current||{},restartTimes:a.simulator.restartTimes,windowStatus:a.window.windowStatus,qcloudUploadIDCShow:a.window.qcloud.uploadIDCShow,qcloudUploadDialogShow:a.window.qcloud.uploadShow,qcloudDeployDialogShow:a.window.qcloud.deployShow,additionLoginShow:a.window.additionLogin&&a.window.additionLogin.show,iconManagerShow:a.window.toolbarConfig&&a.window.toolbarConfig.show,pluginPopup:a.window.pluginPopup||{},pluginManifests:a.config.pluginManifests||{},musicShow:k==_.MUSIC_STATE_PLAY||k==_.MUSIC_STATE_PAUSE}},(a)=>{return{bodyClick:(b)=>{a(V.bodyClick(b))},recordFocus:(b)=>a(g.recordFocus(b)),maximizeWindow:()=>a(g.appMax()),requestProjectAttr:()=>{a(W.requestProjectAttr())},windowActions:Q.bindActionCreators(g,a),simulatorActions:Q.bindActionCreators(h,a),updateSceneConfig:Q.bindActionCreators(S.updateSceneConfig,a),updateLocaleSceneConfig:Q.bindActionCreators(S.updateLocaleSceneConfig,a),setProjectConfig:Q.bindActionCreators(W.setProjectConfig,a),setPluginManifests:Q.bindActionCreators(S.setPluginManifests,a),confirm(b,c){a(fa.setConfirmInfo(_extends({show:!0,showCancel:!1,callback:c},b)))}}})(oa)}(require('lazyload'),require);