'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('glob'),c=require('path'),d=require('url'),e=require('react'),f=require('redux'),{connect:g}=require('react-redux'),h=require('lodash'),i=require('trash'),j=require('rmdir'),k=require('image-size'),l=require('mkdir-p'),m=require('./83822ab95828f61bf6a61c04d53246a8.js'),n=require('./72653d4b93cdd7443296229431a7aa9a.js'),o=require('./d62fc37d7aa6416d5dcc240ba94175cd.js'),p=require('./46f5e82e7b3fd4ec2c8023c3dcf88cc3.js'),q=require('./8c8af9e360a75571110bae2bcbfbba78.js'),r=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),s=require('./a8c87029da0fa06e986298d447ab0fe2.js'),t=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),u=require('./ba23d8b47b1f4ea08b9fd49939b9443f.js'),v=require('./e298e91f85bae5b5a2b792e6e73a55e3.js'),w=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),x=require('./c1e9d0afe2f9700ca354dbeced1f34d5.js'),y=require('./da7c31daaf542cf1796023d8e344b98a.js'),z=require('./4e88c741ca9fb65fab96c500b6d7f2fb.js'),A=require('./41168dca39589e852da6631126d0f94d.js'),B=require('./514f85d2b0873069acdeb636da5dc337.js'),C=require('./874074ba4ecebc4e49310ccc42243ff5.js'),D=require('./cba9f1961ad06faf785db8d4f9fa3ed8.js'),E=require('./3e74bc0c6a5fa450386148788cc0cf44.js'),F=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),G=require('./84b183688a46c9e2626d3e6f83365e13.js'),H=require('./ff946754202ecf377034d29daac7c8d9.js'),I=require('./87f6bf74c03e519db7e665b0f4645468.js'),J=require('./a78e6d6a87de1708226375ca4c320d76.js'),{whiteFileExtName:K}=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),L=require('./f15811258ec83bc7d2978d66ddd5ed8a.js'),M=require('./common/locales/index.js'),N=require('./3892cb9d0783075a973c350c41401370.js'),{validType:O,tokenManager:P}=require('./dc244a5ba483ad6e0acd267d3b91b282.js'),Q={page:{".js":q.pageJS,".json":q.pageJSON,".wxml":q.pageWXML,".wxss":q.pageWXSS},component:{".js":q.componentJS,".json":q.componentJSON,".wxml":q.componentWXML,".wxss":q.componentWXSS}};const R={".jpg":!0,".png":!0,".jpeg":!0,".icon":!0,".gif":!0,".svg":!0,".cer":!0};class S extends e.Component{constructor(a){super(a),this._typeCfg={miniprogram:{config:'app.json',lastConfigCache:{},getPath:this.getClientPath.bind(this)},plugin:{config:'plugin.json',lastConfigCache:{},getPath:this.getPluginPath.bind(this)}}}componentDidMount(){this._onEditorMessage=this.onEditorMessage.bind(this),console.log('editor container mount',new Date),this.init()}componentWillUnmount(){this.cleanup()}componentWillReceiveProps(a){a.editorOpenFileInfo!=this.props.editorOpenFileInfo&&setTimeout(()=>{this.openFile()}),(a.project!=this.props.project&&a.project||a.tcb!=this.props.tcb)&&setTimeout(()=>{this.onUpdateProject()}),a.scfMapInEnv!=this.props.scfMapInEnv&&setTimeout(()=>{this.onSyncTcbFuncList()})}componentDidUpdate(a){a.project!==this.props.project&&a.project&&this.props.project&&(a.project.projectid===this.props.project.projectid?m.remoteEmit('REMOTE_PROJECT_UPDATED',this.props.project):(this.cleanup(),this.init())),a.focus!==this.props.focus&&(a.focus!==w.WINDOW_FOCUS.EDITOR&&this.props.focus===w.WINDOW_FOCUS.EDITOR?m.remoteEmit('REMOTE_FOCUS'):a.focus===w.WINDOW_FOCUS.EDITOR&&this.props.focus!==w.WINDOW_FOCUS.EDITOR&&m.remoteEmit('REMOTE_BLUR')),a.settings.edit.gitIgnoreWindowsReturn!==this.props.settings.edit.gitIgnoreWindowsReturn&&this.notifyGitStatus(),this.props.project.timeRecords&&this.props.project.timeRecords.pluginDocLastUploadTime&&(a.project.timeRecords?a.project.timeRecords.pluginDocLastUploadTime!==this.props.project.timeRecords.pluginDocLastUploadTime&&m.remoteEmit('REMOTE_PROJECT_UPDATED',{timeRecords:this.props.project.timeRecords}):m.remoteEmit('REMOTE_PROJECT_UPDATED',{timeRecords:this.props.project.timeRecords}))}openFile(){m.remoteEmit('OPEN_FILE',this.props.editorOpenFileInfo),m.remoteEmit('REMOTE_FOCUS')}onUpdateProject(){m.remoteEmit('UPDATE_PROJECT',_extends({},this.props.project,{cloudfunctionRoot:this.getTcbFnPath(),jsserverRoot:this.getJSServerPath(),envList:this.props.tcb.envList||[],currentEnv:this.props.currentEnv||{}}))}onSyncTcbFuncList(){let a=this.props.scfMapInEnv[this.props.currentEnv.namespace];m.remoteEmit('UPDATE_TCB_FUNCTIONS',_extends({},a))}init(){this.setupMessageCenter(),this.setupFileUtils(),this.initEditorExtension(),this.mtimes=new Map,this.files=new Map;const a=(a)=>{m.command('setLocale',{locale:a})};a(M.getLocale()),this._cancalLocaleListener=M.onChangeLocale(a)}cleanup(){try{this.cleanupMessageCenter(),this.cleanupFileUtils(),this._cancalLocaleListener()}catch(a){}}get container(){return this._container}set container(a){this._container=a}get editorWebview(){return this._editorWebview}set editorWebview(a){this._editorWebview=a}async setupFileUtils(){await this.getFileUtils(),this._onFileChange=this.onFileChange.bind(this),this.fileUtils.on('all',this._onFileChange)}async getFileUtils(){return this.fileUtils||(this.fileUtils=await o(this.props.project.projectpath)),this.fileUtils}getClientPath(){try{const a=G.normalizePath(this.props.project.miniprogramRoot);return'.'==a||'./'==a||a.startsWith('../')?'':a.endsWith('/')?a.slice(0,-1):a}catch(a){}return''}getTcbFnPath(){try{let a=this.props.project.cloudfunctionRoot;if(a)return G.normalizePath('/'+a+'/')}catch(a){}return''}getJSServerPath(){try{let a=this.props.project.jsserverRoot;if(a)return G.normalizePath('/'+a+'/')}catch(a){}return''}getPluginPath(){try{const a=G.normalizePath(this.props.project.pluginRoot);return'.'==a||'./'==a||a.startsWith('../')?'':a.endsWith('/')?a.slice(0,-1):a}catch(a){}return''}cleanupFileUtils(){this.fileUtils.removeListener('all',this._onFileChange)}setupMessageCenter(){m.register(this._onEditorMessage)}cleanupMessageCenter(){m.unRegister(this._onEditorMessage)}initEditorExtension(){this.loadEditorWebview()}loadEditorWebview(){return this.editorWebview?void this.editorWebview.reload():void this.setupWebview()}setupWebview(){this.editorWebview&&(L.disable(this.editorWebview._webview),this.editorWebview.detach());const a=J.get('devtools',{}),b=J.get('editor',{});b.setAttribute('tabIndex','-1'),b._webview.style.width='100%',b._webview.style.height='100%';const c=P.getSessionToken(O.UA_TOKEN);b.setUserAgentOverride(`${b.originUserAgent} devtoolsedit port/${global.messageCenterPort} proxy/${global.proxyPort} token/${c}`),b.on('dialog',(a)=>{const b=a.messageType||'',c=a.messageText,d=a.dialog;if('alert'===b);else if('confirm'===b){a.preventDefault();try{const a=JSON.parse(c);this.props.confirm(a,(a)=>{a?d.ok():d.cancel()})}catch(a){d&&d.cancel()}}else'prompt'===b&&c===w.GET_MESSAGE_TOKEN&&d.ok(H.getToken())}),b.on('newwindow',(a)=>{nw.Shell.openExternal(a.targetUrl)}),b.on('exit',(a)=>{('abnormal'===a.reason||'crashed'===a.reason||'killed'===a.reason)&&setTimeout(()=>{this.setupWebview()})});const e=/^\/__plugindoc__\/(.+)$/;b.onBeforeRequest=(a)=>{const b=d.parse(a.url).pathname,c=b.match(e);return c&&c[1]?{redirectUrl:`http://127.0.0.1:${global.proxyPort}/editor/files/doc/${c[1]}`}:/^file:\/\//i.test(a.url)?{cancel:!0}:void 0},b.src='html/editor.html',b.attach(this.container),this.editorWebview=b,L.enable(b._webview)}async onEditorMessage(a){switch(a.type){case'FOCUS':{this.onReqFocus(a);break}case'GET_GIT_STATUS':{this.onReqGetGitStatus(a);break}case'REVIEW_FILE':{this.onReqReviewFile(a);break}case'RELOAD':{this.setupWebview();break}case'CLICK':{this.onWebviewClick();break}case'SHOW_EDITOR_IF_NEEDED':{this.props.show||this.props.toggleEditorWindow();break}case'TREE_SHOW':{this.setFileTreeShow();break}case'TREE_HIDE':{this.setFileTreeHide();break}case'GET_FILE':{this.onReqGetFile(a);break}case'GET_COMMIT_FILE':{this.onReqGetCommitFile(a);break}case'GET_TCB_FILE':{this.onReqGetTcbFile(a);break}case'TCB_NEW_NODEJS':{this.onReqTcbNewNodejs(a);break}case'TCB_MULTI':{this.onReqTcbMulti(a);break}case'TCB_DOWNLOAD':{this.onReqTcbDownload(a);break}case'TCB_UPLOAD':{this.onReqTcbUpload(a);break}case'SAVE_FILE':{this.onReqSaveFile(a);break}case'FORMAT_CODE':{this.onReqFormatCode(a);break}case'FIND_IN_FILES':{this.onReqFindInFiles(a);break}case'SYNC_FILES':{this.onReqSyncFiles(a);break}case'INIT_PROJECT':{this.onReqInitProject(a);break}case'GET_API':{this.onReqGetAPI(a);break}case'OPEN_IN_DISK':{this.onReqOpenInDisk(a);break}case'OPEN_IN_TERMINAL':{this.onReqOpenInTerminal(a);break}case'RENAME':{this.rename(a);break}case'ADD_FILE':this.addFile(a);case'ADD_DIR':{this.addDir(a);break}case'ADD_PAGE':{this.addPage(a);break}case'CHECK_PAGE_AND_COMPILE':{this.checkPageAndCompile(a);break}case'ADD_COMPONENT':{this.addComponent(a);break}case'DELETE_FILE':{this.deleteFile(a);break}case'DELETE_DIR':{this.deleteDir(a);break}case'BUILD':{this.onReqBuild(a);break}case'UPLOAD_README':{this.onReqUploadReadme(a);break}case'OPEN_EXTERNAL_URL':{this.onReqOpenExternalURL(a);break}case'TCB_CHANGE_ENV':{this.onReqTcbChangeEnv(a);break}case'TCB_DOWNLOAD_ALL':{this.onReqTcbDownloadAll(a);break}case'TCB_GET_FUNC_LIST':{this.onReqTcbGetFuncList(a);break}case'JSSERVER_UPLOAD':{this.onReqJSServerUpload(a);break}case'JSSERVER_DOWNLOAD':{this.onReqJSServerDownload(a);break}case'JSSERVER_LOADLOG':{this.onReqJSServerLog(a);break}case'JSSERVER_CREATE_RES_DIR':{this.onReqJSServerCreateResDir(a);break}case'JSSERVER_UPLOAD_RES':{this.onReqJSServerUploadRes(a);break}case'JSSERVER_DOWNLOAD_RES':{this.onReqJSServerDownloadRes(a);break}case'JSSERVER_ADD_RES':{this.onReqJSServerAddRes(a);break}}}async onReqJSServerAddRes(b){const d=this.props.project.jsserverRoot,e=c.join(this.props.project.projectpath,d,'resources'),f=await G.chooseFile({multiple:!0});if(f.success){const b=f.event,d=b.target.value.split(';');for(const b of d){const d=c.basename(b),f=c.join(e,d);if(a.existsSync(f)){const a=await this.overwriteConfirm(M.config.OVERWRITE_FILE.format(d));if(!a)continue}G.cpSync(b,f,!0)}}m.callback(b.callback,{})}overwriteConfirm(a){return new Promise((b)=>{this.props.infoActions.setConfirmInfo({show:!0,type:'error',title:M.config.TIP,content:a,showCancel:!0,showConfirm:!0,confirmText:M.config.CONFIRM,callback:(a)=>{b(a)}})})}onReqJSServerCreateResDir(b){const d=this.props.project.jsserverRoot,e=c.join(this.props.project.projectpath,d,'resources');a.existsSync(e)?this.props.infoActions.showSuccessTip(M.config.ALREADY_EXIST):(l.sync(e),this.props.infoActions.showSuccessTip(M.config.CREATE_SUCCESS)),m.callback(b.callback,{})}onReqJSServerUploadRes(a){const b=this.props.project.jsserverRoot,d=c.join(this.props.project.projectpath,b,'resources');this.props.jsserverActions.uploadResources({path:d}),m.callback(a.callback,{})}onReqJSServerDownloadRes(a){const b=this.props.project.jsserverRoot,d=c.join(this.props.project.projectpath,b,'resources');this.props.jsserverActions.downloadResources({type:a.env,writeFile:!0,distPath:d}),m.callback(a.callback,{})}onReqJSServerUpload(a){this.props.jsserverActions.uploadServerScript({path:c.join(this.props.project.projectpath,a.path)}),m.callback(a.callback,{})}onReqJSServerDownload(a){const b=this.getJSServerPath();let d='',e=c.join(this.props.project.projectpath,a.path);a.path!==b&&(d=c.posix.relative(b,a.path),e=c.dirname(e)),this.props.jsserverActions.getServerScript({type:a.env,name:d,distPath:e,writeFile:!0}),m.callback(a.callback,{})}onReqJSServerLog(a){const b=this.getJSServerPath(),d=c.posix.relative(b,a.path);this.props.jsserverActions.getServerScriptLog({name:d}),m.callback(a.callback,{})}async notifyGitStatus(){let a={enabled:!1,head:null};if(await this.isGitEnabled())try{const b=await A({taskName:'getgithead',config:{dir:this.props.project.projectpath},maxTimeout:60000,useBackup:!1,downgrade:!0});if(b.error)throw b.error;a={enabled:!!b.enabled,head:b.enabled?b.head+'':null}}catch(b){console.warn('getgithead error',b),a={enabled:!1,head:null}}m.remoteEmit('REMOTE_GIT_STATUS_CHANGE',{gitEnabled:a})}async onReqTcbNewNodejs(b){try{const d=c.join(this.props.project.projectpath,b.path);l.sync(d);const e=a.lstatSync(d);this.mtimes.set(d,+e.mtime),this.files.set(b.path,!0);const f=c.join(d,'index.js');a.existsSync(f)||a.writeFileSync(f,q.tcbIndexJS);const g=c.join(d,'package.json');a.existsSync(g)||a.writeFileSync(g,q.tcbCloudFunctionPackageJSON.replace('{{name}}',c.basename(b.path))),this.props.tcbActions.uploadTcbFunc({showTips:!0,syncFunctions:!0,createFunction:!0,runtime:'Nodejs8.9',dirPath:d}),m.callback(b.callback,{})}catch(a){m.callback(b.callback,void 0,a.toString())}}async isGitEnabled(){if(this._gitEnabled===void 0){let a=!1;try{const b=await A({taskName:'getgitenabled',config:{dir:this.props.project.projectpath},maxTimeout:60000,useBackup:!1,downgrade:!0});if(b.error)throw b.error;a=b.enabled}catch(b){console.warn('getgitenabled failed',b),a=!1}this._gitEnabled=a}return this._gitEnabled}unsetGitEnabled(){void 0===this._gitEnabled||(this._prevGitEnabled=this._gitEnabled,this._gitEnabled=void 0)}async onFileChange(a,b,d){const e=this.props.project,f=c.relative(e.projectpath,b);/^\.git(\\|\/)/i.test(f)&&this.unsetGitEnabled(),clearTimeout(this._updateGitStatusTimeout),this._updateGitStatusTimeout=setTimeout(async()=>{this._updateGitStatusTimeout=void 0;const a=await this.isGitEnabled();(a||!!this._prevGitEnabled!==!!a)&&(this._prevGitEnabled=a,this.notifyGitStatus())},600);const g=d?+d.mtime:0,h=d?this.getSerializableStat(d):{};let i={};if(b=this.getEditorPathFormat(f),('addDir'===a||'unlinkDir'===a)&&(b+='/'),this.triggerBuild(b,!1),'add'===a||'addDir'===a)this.files.set(b,!0),i={payload:{eventType:a,path:b,stat:h}};else if('unlink'===a||'unlinkDir'===a)this.files.delete(b),i={payload:{eventType:a,path:b,stat:h}};else if('change'===a){if(+this.files.get(b)==g)return;this.files.set(b,g),i={payload:{eventType:a,path:b,stat:h}}}else return void n.info(`edit.js watch ${a}`);i.eventType='REMOTE_EXTERNAL_FILE_CHANGE',i.type='EMIT',m.remoteEmit(i.eventType,i.payload)}triggerBuild(a,b=!0){const d=c.extname(a);if(K[d]){if('/project.config.json'!==a){a=this.normalizePath(a);const b=c.dirname(a),d=this.getClientPath(),e=this.getPluginPath(),f=this.getTcbFnPath(),g=this.getJSServerPath();if(d&&0!==`${b}/`.indexOf(`${d}/`)&&e&&0!==`${b}/`.indexOf(`${e}/`))return;if(f&&0===`/${b}/`.indexOf(`${f}`))return;if(g&&0===`/${b}/`.indexOf(`${g}`))return}const{autoSave:d,autoRefresh:e}=this.props.settings.edit;e&&(!d||b)&&(clearTimeout(this._rebuildCooldownTimeout),this._rebuildCooldownTimeout=setTimeout(()=>{this.props.rebuildImmediate(w.COMPILE_ORIGIN.SAVE_FILE)},w.REBUILD_INTERVAL.AUTO_REFRESH))}}async getFiles(){function b(b){return new Promise((c,d)=>{a.lstat(b,(a,b)=>{a?d(a):c(b)})})}return new Promise(async(a)=>{const d=await this.getFileUtils(),e=d.getAllFileWithDir().map((a)=>'/'+a),f={},g=this.props.project.projectpath;for(const d of e)try{const a=await b(c.join(g,d));f[d]=_extends({},a,{isDir:a.isDirectory(),isFile:!a.isDirectory()})}catch(a){f[d]={}}a({files:e,info:f})})}onReqFocus(){if(this.editorWebview&&this.editorWebview._webview){const a=this.editorWebview._webview;a.click&&a.click(),a.focus&&a.focus(),this.onWebviewClick()}}onWebviewClick(){if(this.editorWebview&&this.editorWebview._webview){const a=new UIEvent('click',{bubbles:!0});this.editorWebview._webview.dispatchEvent(a)}}setFileTreeShow(){this.props.setFileTreeShow(!0)}setFileTreeHide(){this.props.setFileTreeShow(!1)}checkPageAndCompile(b){for(const d in this._typeCfg){const b=this._typeCfg[d],e=c.join(this.props.project.projectpath,b.getPath(),b.config);try{const b=a.readFileSync(e);this.autoAddAllPage(d,b)}catch(a){}}this.onReqBuild(b)}autoAddPageOnInitiativeSave(a){try{const b=this.normalizePath(a.path),d=c.join(this.props.project.projectpath,b);for(const b in this._typeCfg){const e=this._typeCfg[b];d===c.join(this.props.project.projectpath,e.getPath(),e.config)&&this.autoAddAllPage(b,a.data)}}catch(a){}}onReqSaveFile(b){let d;try{b.initiative&&this.autoAddPageOnInitiativeSave(b);const e=this.normalizePath(b.path),f=c.join(this.props.project.projectpath,e);this.fileUtils.writeFileSync(e,b.data,'utf8');const g=a.lstatSync(f);d={errMsg:'',type:'CALLBACK',callback:b.callback,payload:{stat:this.getSerializableStat(g)}},this.mtimes.set(f,+g.mtime),this.files.set(b.path,g.mtime)}catch(a){n.error(`editor.container.js: onReqSaveFile error: ${a}`),d={errMsg:a.toString(),type:'CALLBACK',callback:b.callback}}m.callback(b.callback,d.payload,d.errMsg),y('weapp_editor_savefile',this.props.project.appid),this.props.settings.edit.autoSave&&this.props.settings.edit.autoRefresh&&b.initiative&&this.triggerBuild(b.path,b.initiative)}async onReqGetGitStatus(a){console.log('editor.container.js, onReqGetGitStatus',a);const b={type:'CALLBACK',callback:a.callback,payload:{}};if(await this.isGitEnabled()){let a={};try{const b=await A({taskName:'getgitstatus',config:{dir:this.props.project.projectpath},maxTimeout:60000,useBackup:!1,downgrade:!0});if(b.error)throw b.error;a=b.status||{}}catch(b){console.warn('getGitStatus failed',b),a={}}const c={},d={};for(const b in a){if(!a.hasOwnProperty(b))continue;const e=a[b];d[this.getEditorPathFormat(b)]=c[e]=c[e]||{ignored:B.isStatusIgnored(e),new:B.isStatusNew(e),modified:B.isStatusModified(e),deleted:B.isStatusDeleted(e),staged:B.isStatusStaged(e),conflict:B.isStatusConflict(e)}}b.payload=d}m.callback(a.callback,b.payload)}async onReqReviewFile(a){const b={type:'CALLBACK',callback:a.callback,payload:{gitLineDiffs:[]}},c=this.props.project.projectpath;if(await this.isGitEnabled()){const c=this.normalizePath(a.path);let d=[];try{let b=a.data||'';this.props.settings.edit.gitIgnoreWindowsReturn&&(b=b.replace(/\r\n/g,'\n'));const e=await A({taskName:'getgitlinediffs',config:{dir:this.props.project.projectpath,path:c},dataStr:b,maxTimeout:60000,useBackup:!1,downgrade:!0});if(e.error)throw e.error;d=e.gitLineDiffs||[]}catch(a){d=[]}b.payload.gitLineDiffs=d}m.callback(a.callback,b.payload)}async onReqFormatCode(a){let b;try{b=this.props.settings.edit.tabSize}catch(a){b=2}const c=x(a.data,b);m.callback(a.callback,c)}async onReqInitProject(a){const{files:b,info:c}=await this.getFiles(),d={},e=this.props.settings;for(const b in e.appearance)d[b]=e.appearance[b];for(const b in e.edit)d[b]=e.edit[b];const f={errMsg:'',type:'CALLBACK',callback:a.callback,payload:{project:_extends({},this.props.project,{name:this.props.project.projectname,path:this.props.project.projectpath,createTime:this.props.project.createTime,cloudfunctionRoot:this.getTcbFnPath(),jsserverRoot:this.getJSServerPath(),envList:this.props.tcb.envList||[],currentEnv:this.props.currentEnv||{}}),tcbFnMap:this.props.scfMapInEnv[this.props.currentEnv.namespace],files:b,info:c,config:d}};b.forEach((a)=>{this.files.set(a,!0)}),m.callback(a.callback,f.payload),this.notifyGitStatus()}async onReqGetAPI(a){let b;try{b=!!this.props.project.attr.gameApp}catch(a){b=!1}const c=await z.getFallbackAPI(b);m.callback(a.callback,{files:c})}async onReqSyncFiles(a){const{files:b,info:c}=await this.getFiles(),d={errMsg:'',type:'CALLBACK',callback:a.callback,payload:{files:b,info:c}};b.forEach((a)=>{this.files.set(a,!0)}),m.callback(a.callback,d.payload)}async onReqTcbUpload(a){this.props.tcbActions.uploadTcbFunc({showTips:!0,syncFunctions:!0,dirPath:c.join(this.props.project.projectpath,a.path)}).catch((a)=>{console.error('uploadTcbFunc failed',a)}),m.callback(a.callback,{})}async onReqTcbDownload(b){let d=this.getTcbFnPath(),e=D.getFunctionInfo(d,b.path);const f=c.join(this.props.project.projectpath,b.path),g=a.readdirSync(f);if(!g||0>=g.length)this.props.tcbActions.downloadTcbFunc({showTips:!0,writeFile:!0,functionName:e.functionName,dirPath:f,zipFile:!0});else{const a=document.createElement('input');a.style='display: none',a.setAttribute('type','file'),a.setAttribute('nwdirectory',!0),a.setAttribute('nwsaveas',`${b.path}`),window.document.body.appendChild(a),a.addEventListener('change',(b)=>{const c=b.target.value;c&&this.props.tcbActions.downloadTcbFunc({showTips:!0,writeFile:!0,functionName:e.functionName,dirPath:c,zipFile:!0}),window.document.body.removeChild(a)}),a.addEventListener('cancel',()=>{window.document.body.removeChild(a)}),a.click()}m.callback(b.callback,{})}async onReqTcbMulti(a){this.props.setCloud({fnaction:{show:!0}}),m.callback(a.callback,{})}async onReqGetTcbFile(a){let b=this.getTcbFnPath(),c=D.getFunctionInfo(b,a.path),d=await C.getFileContent({namespace:this.props.tcb.currentEnv.namespace,functionName:c.functionName,filePath:c.filePath,forceUpdate:!0});const e={type:'CALLBACK',callback:a.callback,payload:{content:d.toString(),stats:null}};m.callback(a.callback,e.payload)}async onReqGetCommitFile(a){const b={type:'CALLBACK',callback:a.callback,payload:{content:null,stats:null}};if(await this.isGitEnabled()){let c,d;const e=this.normalizePath(a.path);try{const a=await A({taskName:'getgitcommitfile',config:{dir:this.props.project.projectpath,path:e},maxTimeout:60000,useBackup:!1,downgrade:!0});if(a.error)throw a.error;c=a.content||null,d=a.stats||null}catch(a){console.warn('getGitCommitFile failed',a),c=null,d=null}b.payload.content='string'==typeof c?c:null,b.payload.stats=d||null}m.callback(a.callback,b.payload)}async onReqGetFile(b){if(R[c.extname(b.path).toLowerCase()]){let e=d.resolve(`http://127.0.0.1:${global.proxyPort}/editor/files/`,this.normalizePath(b.path));try{e=decodeURI(e)}catch(a){}const f=c.join(this.props.project.projectpath,this.normalizePath(b.path));if(!this.isSecurePath(f))return;if(!this.isSecurePath(f))return;let g;try{g=k(f)}catch(a){g={width:-1,height:-1}}const h=a.statSync(f);m.callback(b.callback,{url:e,dimension:g,stat:this.getSerializableStat(h)})}else{const d=this.fileUtils.getFile(this.normalizePath(b.path)),e=c.join(this.props.project.projectpath,this.normalizePath(b.path));if(!this.isSecurePath(e))return;const f=a.statSync(e);m.callback(b.callback,{data:d,stat:this.getSerializableStat(f)})}}async onReqFindInFiles(a){const{options:b,string:d}=a;let{cwd:e,i:f,wholeword:g}=b;e=c.join(this.props.project.projectpath,e||'');this.isSecurePath(e)&&p({str:d,cwd:e,i:f,wholeword:g,project:{projectpath:this.props.project.projectpath}},(b,c)=>{const d={type:'CALLBACK',callback:a.callback};b?d.errMsg=JSON.stringify(b):(d.errMsg='',d.payload=c),m.callback(a.callback,d.payload,d.errMsg)})}onReqOpenInTerminal(a){const{path:b}=a,d=c.join(this.props.project.projectpath,b);N(d),m.callback('EDITOR',a.callback,{},'')}onReqOpenInDisk(a){const{path:b}=a,d=c.join(this.props.project.projectpath,b);this.isSecurePath(d)&&(nw.Shell.showItemInFolder(d),m.callback(a.callback,{}))}onReqUploadReadme(a){try{this.props.setUploadPluginDocInfo({show:!0}),m.callback(a.callback,{})}catch(b){m.callback(a.callback,void 0,b.toString())}}onReqOpenExternalURL(a){try{const{link:b}=a;b&&/^http(s):/.test(b)&&nw.Shell.openExternal(b),m.callback(a.callback,{})}catch(b){m.callback(a.callback,void 0,b.toString())}}rename(b){const{oldPath:d,newPath:e}=b;try{const f=c.join(this.props.project.projectpath,d),g=c.join(this.props.project.projectpath,e);if(!this.isSecurePath(f)||!this.isSecurePath(g))return;a.renameSync(f,g),d==this.getTcbFnPath()&&this.props.setTcbFnRoot(`.`+e);const h=a.lstatSync(g);this.files.delete(this.getEditorPathFormat(d)),this.files.set(e,!0),m.callback(b.callback,{stat:this.getSerializableStat(h)})}catch(a){m.callback(b.callback,void 0,a.toString())}}addFile(b){try{const d=c.join(this.props.project.projectpath,this.normalizePath(b.path));if(!this.isSecurePath(d))return;a.writeFileSync(d,'','utf8');const e=a.lstatSync(d);this.mtimes.set(d,+e.mtime);const f={errMsg:'',type:'CALLBACK',callback:b.callback,payload:{stat:this.getSerializableStat(e)}};this.files.set(b.path,!0),m.callback(b.callback,f.payload)}catch(a){m.callback(b.callback,void 0,a.toString())}}addDir(b){try{const d=c.join(this.props.project.projectpath,this.removeTrailingSlash(this.normalizePath(b.path)));if(!this.isSecurePath(d))return;l.sync(d);const e=a.lstatSync(d);this.mtimes.set(d,+e.mtime),this.files.set(b.path,!0),m.callback(b.callback,{stat:this.getSerializableStat(e)})}catch(a){m.callback(b.callback,void 0,a.toString())}}autoAddAllPage(a,b){const c=this._typeCfg[a];let d,e,f;try{f=JSON.parse(b)}catch(a){return}'miniprogram'===a&&(d=c.lastConfigCache.pages||[],e=f.pages||[]),'plugin'===a&&(d=h.values(c.lastConfigCache.pages),e=h.values(f.pages));let g=h.difference(e,d);try{g.forEach((b)=>{this.autoAddPage(b,a)})}catch(a){}c.lastConfigCache=f}autoAddPage(a,b){try{const d=this._typeCfg[b].getPath(),e=this.normalizePath(a),f=c.join(this.props.project.projectpath,d,e),g=c.normalize(c.join(this.props.project.projectpath,d)),h=c.normalize(c.resolve(f,'..'));if(!h.startsWith(g)&&h!==g)return void console.warn('given page path out of range');this.addPageInDir(f,e)}catch(a){}}addPageInDir(b,d){try{const e=c.dirname(b);for(const c in l.sync(e),Q.page)try{a.existsSync(`${b}${c}`)||a.writeFileSync(`${b}${c}`,Q.page[c].replace(/\{\{page\}\}/g,d))}catch(a){}}catch(a){}}addPage(b){try{let d,e,f,g=this.removeTrailingSlash(this.normalizePath(b.path)),h=!1;for(const a in this._typeCfg)try{e=this._typeCfg[a],d=e.getPath();const b=new RegExp(`^${d}/`);let i=g.replace(b,'');if(f=JSON.parse(this.fileUtils.getFile(c.join(d,e.config))),'miniprogram'==a&&(!d||b.test(g))){const a=f.pages||[];a.includes(i)||a.push(i),f.pages=a,h=!0;break}if('plugin'==a&&b.test(g)){const a=f.pages||{},b=c.basename(i);b in a||(a[b]=i),f.pages=a,h=!0;break}}catch(a){}if(!h)return;let i='\t';try{i=this.props.settings.edit.insertSpaces&&this.props.settings.edit.tabSize||'\t'}catch(a){i='\t'}const j=c.join(this.props.project.projectpath,d,e.config);a.writeFileSync(j,JSON.stringify(f,null,i),'utf8');const k=c.join(this.props.project.projectpath,b.path);for(const b in Q.page)try{a.existsSync(`${k}${b}`)||a.writeFileSync(`${k}${b}`,Q.page[b].replace(/\{\{page\}\}/g,g))}catch(a){}const l=a.lstatSync(j);m.callback(b.callback,{stat:this.getSerializableStat(l)})}catch(a){m.callback(b.callback,void 0,a.toString())}}addComponent(b){try{const d=this.getClientPath(),e=new RegExp(`^${d}/`);let f=this.removeTrailingSlash(this.normalizePath(b.path));f=f.replace(e,'');const g=c.join(this.props.project.projectpath,b.path);if(!this.isSecurePath(g))return;for(const b in Q.component)try{a.existsSync(`${g}${b}`)||a.writeFileSync(`${g}${b}`,Q.component[b].replace(/\{\{component\}\}/g,f))}catch(a){}m.callback(b.callback,{})}catch(a){m.callback(b.callback,void 0,a.toString())}}async deleteFile(a){try{const b=c.join(this.props.project.projectpath,a.path);if(!this.isSecurePath(b))return;await i(b),this.files.delete(a.path),m.callback(a.callback,{})}catch(b){m.callback(a.callback,void 0,b.toString())}}async deleteDir(a){try{const b=c.join(this.props.project.projectpath,a.path);if(!this.isSecurePath(b))return;await i(b),a.path==this.getTcbFnPath()&&this.props.setTcbFnRoot(''),this.files.forEach((b,c)=>{c.startsWith(this.getEditorPathFormat(a.path,!0))&&this.files.delete(c)}),m.callback(a.callback,{})}catch(b){m.callback(a.callback,void 0,b.toString())}}async onReqBuild(a){clearTimeout(this._rebuildCooldownTimeout),this._rebuildCooldownTimeout=setTimeout(()=>{this.props.rebuildImmediate(a&&a.data)},w.REBUILD_INTERVAL.AUTO_REFRESH)}onReqTcbChangeEnv(a){this.props.tcbActions.selectEnv(a.index),m.callback(a.callback,{})}onReqTcbDownloadAll(a){this.props.tcbActions.downloadAllTcbFunc({showTips:!0,writeFile:!0}),m.callback(a.callback,{})}onReqTcbGetFuncList(a){this.props.tcbActions.getTcbFuncList({writeFile:!0,showTips:!0}),m.callback(a.callback,{})}getSerializableStat(a){return _extends({},a,{isDir:a.isDirectory(),isFile:!a.isDirectory()})}normalizePath(a){return a=a.replace(/\\/g,'/'),'/'===a[0]?a.substr(1):a}getEditorPathFormat(a,b=!1){return a=a.replace(/\\/g,'/'),b&&!a.endsWith('/')&&(a+='/'),'/'===a[0]?a:'/'+a}removeTrailingSlash(a){return a.endsWith('/')?a.slice(0,-1):a}isSecurePath(a){return a.startsWith(this.props.project.projectpath)}render(){const a=this.props;if(!a.project)return null;let b='monaco';return a.show||(b+=' ui-invisible'),e.createElement('div',{className:b,style:{minHeight:'97px'},tabIndex:-1,ref:(a)=>this.container=a})}}module.exports=g((a)=>{const b=a.project.current,c=b&&b.tcb||{};return{editorOpenFileInfo:a.info.editorOpenFileInfo,show:a.window.editor&&a.window.editor.show,project:b,settings:a.settings,focus:a.window.focus,tcb:c,scfMapInEnv:c.scfMapInEnv,currentEnv:c.currentEnv||{}}},(a)=>({confirm(b,c){a(r.setConfirmInfo(_extends({show:!0,showCancel:!0,callback:c,confirmText:M.config.CONFIRM,cancelText:M.config.CANCEL},b)))},setFileTreeShow(b){a(s.setEditor({fileTreeShow:b}))},toggleEditorWindow(){a(s.toggleEditorWindow())},rebuildImmediate(b){a(u.compileImmediate({origin:b}))},setUploadPluginDocInfo(b){a(r.setUploadPluginDocInfo(b))},setTcbFnRoot(b){a(t.setTcbFnRoot(b))},setCloud(b){a(s.setCloud(b))},infoActions:F.bindActionCreators(r,a),tcbActions:F.bindActionCreators(v,a),jsserverActions:F.bindActionCreators(I,a)}))(S)}(require('lazyload'),require);