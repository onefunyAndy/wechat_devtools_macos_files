'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){function a({except:a=[]}={}){let b=p.readdirSync(H);if(5<b.length)for(let c,d=0,e=b.length;d<e;d++){c=!1;for(let e=0,f=a.length;e<f;e++)if(0==b[d].indexOf(a[e])){c=!0;break}c||B.rmSync(q.join(H,b[d]))}}function b(){try{let a=0,b=p.readdirSync(H);if(0<b.length)for(let c,d=0,e=b.length;d<e;d++)if(c=b[d].match(/(\d+)\.(dmg|exe|wx\.gzip)$/),c&&c[1]){let b=parseInt(c[1]);Number.isInteger(b)&&b>a&&(a=b)}return a}catch(a){return 0}}async function c(a={}){return new Promise((c,d)=>{let e={url:`${x.checkUpdate}?clientversion=${L}&type=${K}`};a.force&&(e.url+='&force=1');let f=b();f&&(e.url+=`&downloadedversion=${f}`),y(e,(b,e,f)=>{if(b)return d(b);try{let b=JSON.parse(f),e=b.baseresponse||{},g=e.errcode;0==g?c({version:b.update_version,forceUpdate:2==b.update_type,versionType:b.version_type,packType:b.pack_type||0,md5:b.md5,whatsnew:b.changelog_desc,whatsnewURL:b.changelog_url,silence:b.silence,manual:!!a.force}):d(g)}catch(a){d(a)}})})}function d(a){const{version:b,packType:c}=a;let d=`${K}_${b}_${c}`,e=J?'dmg':'exe';return(c==P.BIGCODE||c==P.SMALLCODE)&&(e='wx.gzip'),`${d}.${e}`}function e(a){return!!(a&&(a.version>L||a.forceUpdate))}function f(a){return a+='',a.replace(/^(\d)(\d\d)(\d+)$/,function(a,b,c,d){return`${b}.${c}.${d}`})}async function g(a){try{if(!a)return;if(R)return;if(!e(a))return;if(Q)return;let b=await k(a),c=a.silence&&(a.packType==P.BIGCODE||a.packType==P.SMALLCODE);c||(c=await h(a,b)),c&&j(a,b),a.forceUpdate&&(C.forceUpdateVersion=strUpdateVersion)}catch(a){}}function h(a,b){return new Promise((c)=>{let{version:d,forceUpdate:e,packType:g,whatsnewURL:h}=a,j=d<L&&e;global.shareData.updateConfig={updateVersion:f(d),whatsnewURL:h||'https://developers.weixin.qq.com/miniprogram/dev/devtools/uplog.html',isDrawBack:j},o(),T&&(T.removeAllListeners(),T.hide(),T.close(),T=null),nw.Window.open('html/whatsnew.html',{width:600,height:480,title:'\u7248\u672C\u66F4\u65B0\u63D0\u793A',always_on_top:!0},(a)=>{global.windowMap.set('WHATSNEW',a),T=a,a.on('close',function(){T=null,global.shareData&&global.shareData.updateConfig&&(c(global.shareData.updateConfig.confirmInstall),delete global.shareData.updateConfig),this.hide(),this.close(!0)}),a.on('new-win-policy',function(a,b,c){c.ignore(),nw.Shell.openExternal(b)})}),j||i(d,b)})}async function i(a,b){await N.open(),await N.insert('noticecenter',[{type:D.DBType.tools,title:'\u7248\u672C\u66F4\u65B0',content:`最新的开发工具版本 ${a}`,link:q.basename(b),timestamp:Date.now()/1e3}]),await N.close()}async function j(a,b){const{packType:c,version:d}=a;if(c==P.BIGCODE||c==P.SMALLCODE){if(U)try{U.removeAllListeners(),U.kill('SIGTERM')}catch(a){z.error('kill hotpatch task error ',a)}let d=q.join(q.dirname(process.execPath),'node');U=s.fork(F.fileName,['--expose-gc'],{execPath:d,stdio:['ipc'],env:_extends({},process.env,{PACKTYPE:c,HOTPATHTASK:'yes',PackFilePath:b,NewPackageNwPath:J?q.join(I,'new_package.nw'):q.join(process.env.APPDATA,'Tencent','\u5FAE\u4FE1web\u5F00\u53D1\u8005\u5DE5\u5177','new_package.nw'),DistPackageNwPath:J?q.join(I,'package.nw'):q.join(process.env.APPDATA,'Tencent','\u5FAE\u4FE1web\u5F00\u53D1\u8005\u5DE5\u5177','package.nw')})}),U.stdout.on('data',(a)=>{z.log('hotpatch: '+a)}),U.stderr.on('data',(a)=>{z.error('hotpatch: '+a)}),U.on('exit',(b)=>{0==b?(!a.silence||a.manual)&&confirm('\u66F4\u65B0\u5B8C\u6210\uFF0C\u8BF7\u91CD\u65B0\u542F\u52A8')&&(J?t('/Applications/wechatwebdevtools.app/Contents/MacOS/wechatwebdevtools',[],{detached:!0}):t(q.join(q.dirname(process.execPath),'\u5FAE\u4FE1web\u5F00\u53D1\u8005\u5DE5\u5177.exe'),[],{detached:!0}),B.quit()):confirm('\u70ED\u66F4\u65B0\u5931\u8D25\uFF0C\u8BF7\u624B\u52A8\u4E0B\u8F7D\u7248\u672C\u8FDB\u884C\u5B89\u88C5')})}else{let a=J?'open':b,c=J?[b]:[];try{t(a,c,{detached:!0})}catch(a){nw.Shell.openItem(b)}B.quit()}}async function k(b){const{version:c,versionType:e,packType:f}=b;let g=`${K}_${c}_${f}_${Date.now()}${Math.random()}.temp`,h=q.join(H,g),i=q.join(H,d(b));if(p.existsSync(i)&&(!b.md5||G(i,b.md5)))return i;let j='';try{j=`${K}_${c}_${f}`}catch(a){}return await a({except:[j]}),new Promise((a,b)=>{let d='',g={url:`${M}&type=${K}&download_version=${c}&version_type=${e}&pack_type=${f}`,followRedirect:function(a){return d=a.caseless.get('md5'),d}};Q=!0,y(g,(a)=>{return Q=!1,a?b(a):void process.nextTick(()=>{j()})}).pipe(p.createWriteStream(h,{mode:511}));const j=()=>{try{if(!G(h,d))return b('signature not match');p.rename(h,i,(c)=>{return c?b(c):void a(i)})}catch(a){b(a)}}})}function l(){n(),m(),S=setInterval(()=>{n()},O)}function m(){S&&(clearInterval(S),S=null)}async function n(a){let b=await c(a);return g(b),b}function o(){m(),R=!0}const p=require('fs'),q=require('path'),r=require('crypto'),s=require('child_process'),t=require('child_process').spawn,u=require('mkdir-p'),v=require('zlib'),w=require('./514d358c669501bba65151a1ad61ae2f.js'),x=require('./f171257bbcaef547a3cf27266ccb0db2.js'),y=require('./233d77ecf0781f44985f684f70e316d0.js'),z=require('./72653d4b93cdd7443296229431a7aa9a.js'),A=require('./d3ce001ab1e75959382f6a7e0156dd17.js'),B=require('./84b183688a46c9e2626d3e6f83365e13.js'),C=require('./84858de8a097c9cf84ff2c2e3d86e2a9.js'),D=require('./bcb48ae14d243711d3b31cb0f602d209.js'),E=require('./92320c1386e6db6a6f2556736a9bc280.js'),F=require('./cf7d67b3fb34d8276deb78291c77dfff.js'),{checkFileMd5Signature:G}=require('./c3cff51847d72be47e57256891296359.js'),H=E.WeappApplication,I=E.WeappCode,J='darwin'===process.platform,K=global.appConfig.isBeta?J?'beta_darwin':'x64'===process.arch?'beta_x64':'beta_ia32':J?'darwin':'x64'===process.arch?'x64':'ia32',L=parseInt(global.appVersion.replace(/\./g,'')),M=`${x.downloadRedirectURL}?os=${J?'darwin':'win'}`,N=require('./4102b43ad51182743111f5d5e1fc5b46.js'),O=600000,P={INSTALLER:0,BIGCODE:1,SMALLCODE:2};var Q=!1,R=!1,S=null,T=null,U=null;module.exports={loop:l,checkNeedUpdate:async function(){try{let a=await n({force:!0});if(e(a))return f(a.version)}catch(a){}},resetAlreadyNotify:function(){global.isDevWindow||S||l(),R=!1}}}(require('lazyload'),require);