'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('adm-zip'),d=require('jszip'),e=require('./15ba1827c7f6564a45df6bd44da3a977.js'),f=require('./92320c1386e6db6a6f2556736a9bc280.js'),g=require('./f171257bbcaef547a3cf27266ccb0db2.js'),h=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),i=require('./common/locales/index.js'),j=h.CONTENTTYPEINFO,k=()=>({".png":{type:'img',name:i.config.IMAGE},".jpg":{type:'img',name:i.config.IMAGE},".jpeg":{type:'img',name:i.config.IMAGE},".gif":{type:'img',name:i.config.IMAGE},".bmp":{type:'img',name:i.config.IMAGE},".ogg":{type:'video',name:i.config.MULTIMEDIA},".mp3":{type:'audio',name:i.config.AUDIO},".mp4":{type:'audio',name:i.config.VIDEO},".m4a":{type:'audio',name:i.config.VIDEO},".wav":{type:'audio',name:i.config.AUDIO},".aac":{type:'audio',name:i.config.AUDIO},".silk":{type:'audio',name:i.config.AUDIO},".svg":{type:'img',name:i.config.VECTOR_GRAPHICS}}),l=2097152,m=8388608,n=(a,b)=>{if(0==a.returnCode)return a.data;if(1003==a.returnCode){const a=new Error(i.config.QCLOUD_CDN_NOT_OPEN);throw a.code=1003,a}else throw new Error(`${b} ${a.returnCode}:${a.returnMessage}`)},o=async()=>{const{body:a}=await e({url:g.getCosTicket,needToken:1,needAppID:1});return{CosTicket:a.cos_ticket,username:a.username}},p=async(a)=>{const b=global.windowMap.get(h.WINDOW_REGISTRY.MATERIAL).window,c=document.createElement('input');return c.style.display='none',c.setAttribute('type','file'),a.accept&&c.setAttribute('accept',a.accept),a.multiple&&c.setAttribute('multiple','multiple'),b.document.body.appendChild(c),c.click(),new Promise((a)=>{c.addEventListener('change',(d)=>{b.document.body.removeChild(c),a({success:!0,event:d})}),c.addEventListener('cancel',(d)=>{b.document.body.removeChild(c),a({success:!1,event:d})})})};module.exports={get whiteFileExtName(){return k()},getUploadFiles:async(c=()=>{})=>{const e=await p({accept:'video/*,audio/*,image/*,application/zip',multiple:!0});if(e.success){const f=new d,g=e.event,h=g.target.value.split(';');if(1==h.length&&/\.zip$/.test(h[0])){const e=await d.loadAsync(a.readFileSync(h[0]));for(const a in e.files){const d=e.files[a];let g=b.extname(a)||'';if(g=g.toLowerCase(),k()[g]){const b=await d.async('nodebuffer'),e=b.length;e>l?c('ignore',{file:a,reason:i.config.FILE_SIZE_TOO_BIG.format([e,l/1048576])}):(f.file(a,b,{binary:!0}),c('zip',{file:a,length:e}))}else d.dir?f.folder(a):c('ignore',{file:a,reason:i.config.NON_WHITELIST_FILE})}const g=await f.generateAsync({type:'nodebuffer',addUnicodeExtraField:!1});if(g.length>m)throw new Error(i.config.DATA_PACKAGE_SIZE_TOO_BIG.format([g.length,m/1048576]));return g}h.forEach((d)=>{const e=b.extname(d),g=b.basename(d);if(k()[e]){const b=a.readFileSync(d),e=b.length;e>l?c('ignore',{file:g,reason:i.config.FILE_SIZE_TOO_BIG.format([e,l/1048576])}):(f.file(g,b,{binary:!0}),c('zip',{file:g,length:e}))}else c('ignore',{file:g,reason:i.config.NON_WHITELIST_FILE})});const j=await f.generateAsync({type:'nodebuffer',addUnicodeExtraField:!1});if(j.length>m)throw new Error(i.config.DATA_PACKAGE_SIZE_TOO_BIG.format([j.length,m/1048576]));return j}},getCosTicket:o,getTaskId:async()=>{const a=await o(),{body:b}=await e({url:g.cosAction,method:'post',body:JSON.stringify(_extends({action:'GetTaskId'},a)),needAppID:-1,needCheckErrCode:-1});return n(b,'GetTaskId')},getTaskResult:async(a)=>{const b=await o(),{body:c}=await e({url:g.cosAction,method:'post',body:JSON.stringify(_extends({action:'TaskResult',taskId:a},b)),needAppID:-1,needCheckErrCode:-1});return n(c,'TaskResult')},getResources:async(a)=>{const c=await o(),{body:d}=await e({url:g.cosAction,method:'post',body:JSON.stringify(_extends({action:'GetResources',directory:a||'/',page_no:0,page_size:1e3},c)),needAppID:-1,needCheckErrCode:-1}),f=n(d,'GetResources'),h=f.file_list.map((c)=>{const d=/\/$/.test(c.relative_path);let e={};if(!d){let a=b.extname(c.relative_path);a=(a||'').toLowerCase(),e=k()[a]||{}}return{isDir:d,fileInfo:e,isOpen:!1,path:a+c.relative_path,name:b.basename(c.relative_path),url:c.url,md5:c.md5,size:c.size,lastModified:c.last_modified,children:[]}});return h},upload:async(c,d)=>{const h=await o(),i=b.join(f.Weappdest,`${Date.now()}${Math.random()}.zip`);a.writeFileSync(i,c);const{body:j}=await e({url:g.cosAction,method:'post',formData:_extends({action:'UploadFiles',directory:d||'/',file:a.createReadStream(i)},h),needAppID:-1,needCheckErrCode:-1});return n(j,'UploadFiles')},RemoveResources:async(a)=>{const b=await o(),{body:c}=await e({url:g.cosAction,method:'post',body:JSON.stringify(_extends({action:'RemoveResource',relative_path_list:a},b)),needAppID:-1,needCheckErrCode:-1});return n(c,'RemoveResources')},getResourceDetail:async(a,b)=>{const{resp:c}=await e({url:b,headers:{Range:'bytes=0-10'},needToken:-1,needAppID:-1,needParse:-1}),d=c.headers['content-type'].replace(/;.*/g,''),f=j[d.toLowerCase()],g=k()[`.${f}`];return{currentPath:a,ext:(f||'').toUpperCase(),type:g?g.type:'unknown',name:g?g.name:i.config.MENU_TITLE_FILE}}}}(require('lazyload'),require);