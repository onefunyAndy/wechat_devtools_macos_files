'use strict';!function(require,directRequire){const a=require('react'),{connect:b}=require('react-redux'),c=require('./233d77ecf0781f44985f684f70e316d0.js'),d=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),e=require('./72653d4b93cdd7443296229431a7aa9a.js'),f=require('./3b5f8e2469c474c8d433c1c6926d8999.js'),g=require('./f171257bbcaef547a3cf27266ccb0db2.js'),h=require('./9c906d27ca74e18d0deaaa231e71fdfa.js'),i=require('./a8c87029da0fa06e986298d447ab0fe2.js'),j=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),k=require('./5bdce4f0657e887a1fda83e134c0b823.js'),l=require('./89ba85d67a88f7636d657c22b5d3e038.js'),m=require('./common/locales/index.js'),n='darwin'===process.platform?'darwin':'win',o=d.LOGIN_QR_STATUS,p={REQ_ERR_RETRY_INTERVAL:500,SCANNED_TIMEOUT:500,CANCELLED_TIMEOUT:2e3,KEEP_ALIVE_TIMEOUT:2e3,RELOAD_TO_LONGPOLL_TIMEOUT:100,LONGPOLL_TIMEOUT:6e4},q=3,r=10,s=/"(https:\/\/long.open.weixin.qq.com\/connect\/l\/qrconnect\?uuid=.+?)"/,t=/src="\/(connect\/qrcode\/.+)"/,u=require('./da7c31daaf542cf1796023d8e344b98a.js');class v extends a.Component{constructor(a){super(a),this.autoRefreshCountdown=q,this.reloadErrCountdown=r,this.state={status:o.NOT_SCAN,errMsg:''}}componentDidMount(){this.reloadQRCode(),'noticecenter'==this.props.from?u('app_sub_login'):'mainlogin'==this.props.from&&u('app_main_login'),this._cancalLocaleListener=m.onChangeLocale(()=>this.forceUpdate())}componentWillReceiveProps(a){a.user.loginStatus===d.LOGIN_STATUS.FAIL&&this.reloadQRCode()}componentDidUpdate(a,b){b.status!==this.state.status&&'function'==typeof this.props.setStatus&&this.props.setStatus(this.state.status)}componentWillUnmount(){if(this.pollingReq)try{this.pollingReq.abort()}catch(a){}clearTimeout(this.reloadQRCodeTimeout),clearTimeout(this._longPollID),this._cancalLocaleListener()}reset(a){if(this.pollingReq)try{this.pollingReq.abort()}catch(a){}this.reloadErrCountdown=r,this.autoRefreshCountdown=q,a===o.OCCUPIED&&(global.CLI.pendingLogin=!1),this.reloadQRCode()}async reloadQRCode(){if(global.CLI.pendingLogin)return void this.setOccupied();clearTimeout(this._longPollID),this.setState({status:o.NOT_SCAN,errMsg:''});let a;try{const b=await k.getLoginPage();a=b.body}catch(a){if(e.error(`login fail with code ${a.code}\n${a.message}\n${a.stack} `),this.reloadErrCountdown--,0>=this.reloadErrCountdown||'ECONNRESET'===a.code||'ENOTFOUND'===a.code)return void this.setState({status:o.NETWORK_ERROR,errMsg:a.toString()});return clearTimeout(this.reloadQRCodeTimeout),void(this.reloadQRCodeTimeout=setTimeout(this.reloadQRCode.bind(this),p.REQ_ERR_RETRY_INTERVAL))}let b,c;try{const d=await k.extractLoginInfo(a);b=d.qrcode,c=d.longPollURL,this.QRCodeImgElement&&(this.QRCodeImgElement.src=b),this._longPollURL=c,this._longPollID=setTimeout(()=>this.longPoll(),p.RELOAD_TO_LONGPOLL_TIMEOUT)}catch(a){if(e.error(`get login qr code fail with ${a.code}\n${a.message}\n${a.stack}`),this.reloadErrCountdown--,0>=this.reloadErrCountdown)return void this.setState({status:o.UNKNOWN,errMsg:a.toString()});clearTimeout(this.reloadQRCodeTimeout),this.reloadQRCodeTimeout=setTimeout(this.reloadQRCode.bind(this),p.REQ_ERR_RETRY_INTERVAL)}}longPoll(a){return clearTimeout(this._longPollID),global.CLI.pendingLogin?void this.setOccupied():void(this.pollingReq=c({url:`${this._longPollURL}${a?'&last='+a:''}&_=${+new Date}`,headers:{"Content-Type":'application/javascript'},timeout:p.LONGPOLL_TIMEOUT},async(a,b,c)=>{eval(c);const e=window.wx_errcode;switch(e){case d.LOGIN_WX_ERRR_CODE.SUCCESS:{let a=g.LOGIN_REDIRECT_URL;a=a.replace(/&amp;/g,'&'),a+=(-1<a.indexOf('?')?'&':'?')+`code=${wx_code}&state=${n}`,this.setState({status:o.CONFIRM,errMsg:''});try{const b=await l.requestLogin(a);this.props.onLoginSuccess(b)}catch(a){'string'==typeof a&&-1<a.indexOf('connect')?this.setState({status:o.REDIRECT_NETWORK_ERROR,errMsg:''}):this.reloadQRCode()}break}case d.LOGIN_WX_ERRR_CODE.SCANNED:{this.setState({status:o.SCAN,errMsg:''}),this._longPollID=setTimeout(this.longPoll.bind(this),p.SCANNED_TIMEOUT,e);break}case d.LOGIN_WX_ERRR_CODE.CANCELLED:{this.setState({status:o.CANCEL,errMsg:''}),this._longPollID=setTimeout(this.longPoll.bind(this),p.CANCELLED_TIMEOUT,e);break}case d.LOGIN_WX_ERRR_CODE.TIMEOUT:{0<this.autoRefreshCountdown&&(this.reloadQRCode(),this.autoRefreshCountdown--,0>=this.autoRefreshCountdown&&this.setState({status:o.OUTDATED,errMsg:''}));break}case d.LOGIN_WX_ERRR_CODE.ERROR:{this.reloadQRCode();break}case d.LOGIN_WX_ERRR_CODE.KEEP_ALIVE:this._longPollID=setTimeout(this.longPoll.bind(this),p.KEEP_ALIVE_TIMEOUT);default:}e!==d.LOGIN_WX_ERRR_CODE.TIMEOUT&&(this.autoRefreshCountdown=q)}))}setOccupied(){this.QRCodeImgElement&&(this.QRCodeImgElement.src=''),this.setState({status:o.OCCUPIED,errMsg:''})}render(){const b={},c={display:'none'},d=this.state.status,e=d===o.SCAN||d===o.CONFIRM,g=d===o.OUTDATED,h=d===o.NETWORK_ERROR||d===o.REDIRECT_NETWORK_ERROR,i=d===o.UNKNOWN,j=d===o.OCCUPIED;return a.createElement('div',{className:'authenticate-qrcode',style:f.nodrag},a.createElement('img',{ref:(a)=>this.QRCodeImgElement=a,alt:'',src:''}),a.createElement('i',{className:'ui-icon-mini-app-circle'}),a.createElement('div',{className:'authenticate-result',style:e?b:c},a.createElement('i',{className:'ui-icon-tick-circle'}),a.createElement('h4',{className:'authenticate-result-title'},m.config.LOGIN_QR_CODE_SUCCESS)),a.createElement('div',{className:'authenticate-result',style:g?b:c},a.createElement('a',null,a.createElement('i',{className:'ui-icon-reload',onClick:this.reset.bind(this)})),a.createElement('h4',{className:'authenticate-result-title authenticate-result-title-warn'},m.config.LOGIN_QR_CODE_EXPIRED),a.createElement('p',{className:'authenticate-result-subtitle'},m.config.LOGIN_QR_CODE_REFRESH)),a.createElement('div',{className:'authenticate-result',style:h?b:c},a.createElement('a',null,a.createElement('i',{className:'ui-icon-reload',onClick:this.reset.bind(this)})),a.createElement('h4',{className:'authenticate-result-title authenticate-result-title-warn'},m.config.NETWORK_ERR),a.createElement('p',{className:'authenticate-result-subtitle'},m.config.LOGIN_QR_CODE_NETWORK_SUBTITLE)),a.createElement('div',{className:'authenticate-result',style:i?b:c},a.createElement('a',null,a.createElement('i',{className:'ui-icon-reload',onClick:this.reset.bind(this)})),a.createElement('h4',{className:'authenticate-result-title authenticate-result-title-warn'},m.config.UNKNOWN_ERR),this.state.errMsg?a.createElement('p',{className:'authenticate-result-subtitle'},this.state.errMsg):a.createElement('p',{className:'authenticate-result-subtitle'},m.config.LOGIN_QR_CODE_NETWORK_SUBTITLE)),a.createElement('div',{className:'authenticate-result',style:j?b:c},a.createElement('a',null,a.createElement('i',{className:'ui-icon-reload',onClick:this.reset.bind(this,o.OCCUPIED)})),a.createElement('h4',{className:'authenticate-result-title authenticate-result-title-warn'}),a.createElement('p',{className:'authenticate-result-subtitle'},m.config.LOGIN_QR_CODE_OCCUPIED_ERROR)))}}const w=(a)=>({user:a.user}),x=(a)=>({userActions:j.bindActionCreators(h,a)});module.exports=b(w,x,null,{withRef:!0})(v)}(require('lazyload'),require);