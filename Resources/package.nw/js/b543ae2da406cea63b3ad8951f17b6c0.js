'use strict';!function(require,directRequire){function a(b){if(m){const c=o.get(b);if(c){if(c.heartbeatPendingCount>r)return d.info(`unresponsive client window (id: ${b}) will be disconnected`),t(b),s({id:b,projectid:c.projectid,fromAction:!0}),o.delete(b),void n.delete(b);c.heartbeatPendingCount++,c.timeoutId=setTimeout(a.bind(this,b),q),m.postMessage({type:e.EVENT_HEARTBEAT,id:b})}}}function b(b){const{data:c}=b;switch(c.type){case e.EVENT_HEARTBEAT:{if(c.id){const a=o.get(c.id);a&&a.heartbeatPendingCount--}break}case e.EVENT_DEV_WINDOW_OPENED:{c.id&&(o.set(c.id,{[e.INIT_TIME]:+new Date,id:c.id,projectid:c.projectid,heartbeatPendingCount:0}),n.delete(c.projectid),u(),a(c.id)),p.emit(e.EVENT_DEV_WINDOW_OPENED,c.id),p.emit(`${e.EVENT_DEV_WINDOW_OPENED}-${c.id}`,c.id),p.emit(`${e.EVENT_DEV_WINDOW_OPENED}-${c.projectid}`,c.projectid);break}case e.EVENT_DEV_WINDOW_CLOSE:{s(c);break}case e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE:{o.has(c.id)?c[e.CLI_PORT]?(o.get(c.id)[e.CLI_PORT]=c[e.CLI_PORT],p.emit(e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE,c.id,c.projectid,c[e.CLI_PORT]),p.emit(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${c.id}`,c.id,c.projectid,c[e.CLI_PORT]),p.emit(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${c.projectid}`,c.id,c.projectid,c[e.CLI_PORT])):d.info(`server.sync.js: a dev window notify the update of cli port without an cliPort argument, id: ${c.id}`):d.info(`server.sync.js: a dev window, whose id is not present in client window map, notify the update of cli port: ${c.id}`);break}case e.CHANGE_LOCALE:{l.getSourceLocale()!==c.locale&&l.setLocale(c.locale);break}}}const c=require('events'),d=require('./72653d4b93cdd7443296229431a7aa9a.js'),e=require('./09060286633d09fb81fefc8ff1294dd7.js'),f=require('./84b183688a46c9e2626d3e6f83365e13.js'),g=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),h=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),i=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),j=require('./205e69607c4b60711b15f5ac95b40ce4.js'),k='darwin'===process.platform,l=require('./common/locales/index.js');let m;const n=new Set,o=new Map,p=new c,q=6000,r=10,s=(a)=>{o.has(a.id)?(a.id===j.getCurrentBrowsingContext()&&j.setCurrentBrowsingContext(j.getMainWindowHandle()),o.delete(a.id),d.info(`dev window with id ${a.id} closed, cur ctx: ${j.getCurrentBrowsingContext()}`)):d.info(`server.sync.js: a dev window whose id is not present in client window map is closed: ${a.id}`),p.emit(e.EVENT_DEV_WINDOW_CLOSE,a.id),0===o.size&&(k?a.fromAction?(g.dispatch(h.selectDevType(i.DEV_TYPE.MINI_PROGRAM)),global.Win.show()):(global.Win.show(),global.Win.hide()):a.fromAction?(g.dispatch(h.selectDevType(i.DEV_TYPE.MINI_PROGRAM)),global.Win.show()):global.contentDocument.hidden&&(0===n.size?f.quit():setTimeout(()=>{0===o.size&&global.contentDocument.hidden&&f.quit()},5e3)))},t=(a)=>{return!!m&&(m.postMessage({type:e.COMMAND_DEV_WINDOW_CLOSE,id:a}),!0)},u=()=>{m&&m.postMessage({type:e.EVENT_SVR_WINDOW_CLI_PORT_UPDATE,cliPort:global.cliPort})};module.exports={init:()=>{m=new BroadcastChannel(e.BROADCAST_CHANNEL_NAME),m.onmessage=b,p.on(e.EVENT_DEV_WINDOW_OPENED,()=>{global.Win.hide()})},once:(a)=>new Promise((b)=>{p.once(a,b)}),onceWindowOpen:({id:a,projectid:b}={})=>new Promise((c)=>{a||(a=b),p.once(`${e.EVENT_DEV_WINDOW_OPENED}-${a}`,c)}),onceCliPortUpdate:({id:a,projectid:b}={})=>new Promise((c)=>{a||(a=b),p.once(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${a}`,(a,b,d)=>{c(d)})}),pendingOpenWindows:n,clientWindows:o,serverSyncEvents:p,closeDevWindow:t,closeAllDevWindows:()=>{return!!m&&(m.postMessage({type:e.COMMAND_DEV_WINDOW_CLOSE_ALL}),!0)},notifyCliPortUpdate:u,getClientIdByProjectId:function(a){for(const[b,c]of o)if(c&&c.projectid===a)return b;return null},notifyChangeLocale:(a)=>{m&&m.postMessage({type:e.CHANGE_LOCALE,locale:a})}}}(require('lazyload'),require);